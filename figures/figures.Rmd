---
title: "Figures"
output: html_notebook
---

```{r, message=FALSE}
library(ggplot2)
library(tidyr)
library(dplyr)
library(gridExtra)
library(grid)
library(readr)
library(latex2exp)
library(MASS) 
library(scales)

options(scipen=1000000)

kl_divergence <- function(p, q) {
  sum(p * log(p/q))
}
```


# Load data
```{r, eval=FALSE, echo=FALSE, message=FALSE}
data_path <- "~/Code/infomercial/data/"

# ----------------------------------------------------------------------------
# Load example traces
# All values for eta only
value_traces <- read_csv(paste(data_path, "example_value_traces_eta_BanditOneHigh10-v0.csv", sep=""))
value_traces$env <- rep("BanditOneHigh10-v0", nrow(value_traces))

# Get indiv. files
example_trace1 <- read_csv(paste(data_path, "example_traces_epsilon_BanditOneHigh10-v0.csv", sep=""))
example_trace1$env <- rep("BanditOneHigh10-v0", nrow(example_trace1))
example_trace2 <-read_csv(paste(data_path, "example_traces_eta_BanditOneHigh10-v0.csv", sep=""))
example_trace2$env <- rep("BanditOneHigh10-v0", nrow(example_trace2))
example_trace3 <- read_csv(paste(data_path, "example_traces_softbeta_BanditOneHigh10-v0.csv", sep=""))  
example_trace3$env <- rep("BanditOneHigh10-v0", nrow(example_trace3))

example_trace4 <- read_csv(paste(data_path, "example_traces_epsilon_BanditTwoHigh10-v0.csv", sep=""))
example_trace4$env <- rep("BanditTwoHigh10-v0", nrow(example_trace4))
example_trace5 <- read_csv(paste(data_path, "example_traces_eta_BanditTwoHigh10-v0.csv", sep=""))
example_trace5$env <- rep("BanditTwoHigh10-v0", nrow(example_trace5))
example_trace6 <- read_csv(paste(data_path, "example_traces_softbeta_BanditTwoHigh10-v0.csv", sep=""))
example_trace6$env <- rep("BanditTwoHigh10-v0", nrow(example_trace6))

example_trace7 <- read_csv(paste(data_path, "example_traces_epsilon_BanditHardAndSparse10-v0.csv", sep=""))
example_trace7$env <- rep("BanditHardAndSparse10-v0", nrow(example_trace7))
example_trace8 <- read_csv(paste(data_path, "example_traces_eta_BanditHardAndSparse10-v0.csv", sep=""))
example_trace8$env <- rep("BanditHardAndSparse10-v0", nrow(example_trace8))
example_trace9 <- read_csv(paste(data_path, "example_traces_softbeta_BanditHardAndSparse10-v0.csv", sep=""))
example_trace9$env <- rep("BanditHardAndSparse10-v0", nrow(example_trace9))

example_trace10 <- read_csv(paste(data_path, "example_traces_epsilon_BanditUniform121-v0.csv", sep=""))
example_trace10$env <- rep("BanditUniform121-v0", nrow(example_trace10))
example_trace11 <- read_csv(paste(data_path, "example_traces_eta_BanditUniform121-v0.csv", sep=""))
example_trace11$env <- rep("BanditUniform121-v0", nrow(example_trace11))
example_trace12 <- read_csv(paste(data_path, "example_traces_softbeta_BanditUniform121-v0.csv", sep=""))
example_trace12$env <- rep("BanditUniform121-v0", nrow(example_trace12))
  
# Join 'em
example_traces <- rbind(
  example_trace1,
  example_trace2,
  example_trace3,
  example_trace4,
  example_trace5,
  example_trace6,
  example_trace7,
  example_trace8,
  example_trace9,
  example_trace10,
  example_trace11,
  example_trace12
)
example_traces$agents <- factor(example_traces$agents, levels=c("eta", "softbeta", "epsilon"))

# Free memory
rm(
  example_trace1,
  example_trace2,
  example_trace3,
  example_trace4,
  example_trace5,
  example_trace6,
  example_trace7,
  example_trace8,
  example_trace9,
  example_trace10,
  example_trace11,
  example_trace12
)

# ----------------------------------------------------------------------------
# Load all data
traces <- NULL
total <- NULL
critic <- NULL
bandit <- NULL
bandit_names <- c("BanditOneHigh10-v0", "BanditTwoHigh10-v0", "BanditUniform121-v0", "BanditHardAndSparse10-v0")
for(bandit_name in bandit_names){
  tmp <- read_csv(paste(data_path, "table_total_", bandit_name, ".csv", sep=""))
  tmp$env <- rep(bandit_name, nrow(tmp))
  total <- rbind(total, tmp)
  
  tmp <- read_csv(paste(data_path, "table_critic_", bandit_name, ".csv", sep=""))
  tmp$env <- rep(bandit_name, nrow(tmp))
  critic <- rbind(critic, tmp)
  
  tmp <- read_csv(paste(data_path, "table_bandit_", bandit_name, ".csv", sep=""))
  tmp$env <- rep(bandit_name, nrow(tmp))
  bandit <- rbind(bandit, tmp)
}

# Set agent order
total$agents <- factor(total$agents, 
                       levels=rev(c("eta", "beta", "softbeta", "epsilon", "anneal-epsilon", "random")))
critic$agents <- factor(critic$agents, 
                        levels=rev(c("eta", "beta", "softbeta", "epsilon", "anneal-epsilon", "random")))

paper_names <- c("Dual value", "Bayesian (det.)", "Bayesian", "E-greedy", "Anneal-E", "Random")
total$agents <- recode(total$agents, 
                       eta=paper_names[1], 
                       beta=paper_names[2], 
                       softbeta=paper_names[3], 
                       epsilon=paper_names[4], 
                       'anneal-epsilon'=paper_names[5], 
                       random=paper_names[6])

# Drop Beta det.
total <- filter(total, agents != "Bayesian (det.)")
rm(tmp)
```

# Fig 1 - Bee cartoon
This is dummy section; see image itself.


# Fig 2 - Bandits
## Build
```{r, fig.width=2.3, fig.height=1.2}
# ------------------------------------------------------------------------
# Create panels for each of the bandits
bandit %>% 
  filter(env == "BanditOneHigh10-v0") %>% 
  ggplot(aes(x=as.factor(arms+1), y=p_reward)) +
  geom_bar(stat="identity", width=1, fill="black") +
  geom_point(aes(x=8, y=0.9), color="darkgrey", size=0.5, alpha=0.95) +
  theme_classic() +
  geom_text(x=3, y=1, label="I", size=6) +
  scale_y_continuous(breaks=c(0, 0.5, 1), limits = c(0, 1)) +
  scale_x_discrete(breaks=seq(1, 10), labels=c(1, rep(" ", 8), 10)) +
  labs(x=" ", y=" ") -> bandit1

bandit %>% 
  filter(env == "BanditTwoHigh10-v0") %>% 
  ggplot(aes(x=as.factor(arms+1), y=p_reward)) +
  geom_bar(stat="identity", width=1, fill="black") +
  geom_point(aes(x=8, y=0.9), color="darkgrey", size=0.5, alpha=0.95) +
  theme_classic() +
  geom_text(x=3, y=1, label="II", size=6) +
  scale_y_continuous(breaks=c(0, 0.5, 1), limits = c(0, 1)) +
  scale_x_discrete(breaks=seq(1, 10), labels=c(1, rep(" ", 8), 10)) +
  labs(x=" ", y=" ") -> bandit2

bandit %>% 
  filter(env == "BanditHardAndSparse10-v0") %>% 
  ggplot(aes(x=as.factor(arms+1), y=p_reward)) +
  geom_bar(stat="identity", width=1, fill="black") +
  geom_point(aes(x=8, y=0.9), color="darkgrey", size=0.5, alpha=0.95) +
  theme_classic() +
  geom_text(x=3, y=1, label="III", size=6) +
  scale_y_continuous(breaks=c(0, 0.5, 1), limits = c(0, 1)) +
  scale_x_discrete(breaks=seq(1, 10), labels=c(1, rep(" ", 8), 10)) +
  labs(x=" ", y=" ") -> bandit3

bandit %>% 
  filter(env == "BanditUniform121-v0") %>% 
  ggplot(aes(x=as.factor(arms+1), y=p_reward)) +
  geom_bar(stat="identity", width=1, fill="black") +
  geom_point(aes(x=55, y=0.9), color="darkgrey", size=0.5, alpha=0.95) +
  theme_classic() +
  geom_text(x=6, y=1, label="IV", size=6) +
  scale_y_continuous(breaks=c(0, 0.5, 1), limits = c(0, 1)) +
  scale_x_discrete(breaks=seq(1, 121), labels=c(1, rep(" ", 119), 121)) +
  labs(x="Arm", y=" ") -> bandit4

# --------------------------------------------------------------------------------
# Build Fig
xlabel <- textGrob("Arm", vjust=-1.5, gp = gpar(fontsize = 12))
ylabel <- textGrob(TeX("$P_R$"), hjust=-1, gp = gpar(fontsize = 12))

head1 <- textGrob("Multi-armed\nbandits", vjust=0, gp = gpar(fontsize = 13))
plot_grid <- rbind(
  c(rep(5, 4), rep(1, 4), rep(2, 4), rep(3, 4)),
  rep(4, 16)
)

fig2 <- grid.arrange(bandit1, bandit2, bandit3, bandit4, head1, layout_matrix=plot_grid)
ggsave("img/fig2.png", fig2, width=2.3*2, height=1.2*2, dpi = 300)
```

# Fig 3 - Agent performance
## Subfig - regret
```{r, fig.width=1.2, fig.height=2}
# Build Regret panels
total %>% 
  # Stats
  filter(env == "BanditOneHigh10-v0") %>% 
  group_by(agents, env) %>% 
  summarise(M = median(regrets), SD=mad(regrets)) %>% 
  # Plots
  ggplot(aes(x=agents, y=M, color=agents)) +
  geom_point(alpha=1, size=1.5) +
  geom_linerange(aes(ymin=M-SD, ymax=M+SD), width=.4) +
  theme_classic() +
  theme(legend.position="none",
         plot.tag = element_text(size=14, face="bold"),
        plot.margin = margin(.1, .1, .1, .1, "cm")) +
  labs(x=" ", y=" ") +
  geom_text(x=5, y=1.4, label="Bandit I", color="black") +
  geom_hline(aes(yintercept=0), color="black", size=.2) +
  scale_color_manual(
    "Agent",
    values=rev(c("darkorchid4", "mediumpurple3", "mediumpurple1", "steelblue3", "steelblue1", "grey"))) +
  scale_y_log10(
    breaks = trans_breaks("log10", function(x) 10^as.integer(x)),
    labels = trans_format("log10", math_format(10^.x))
  ) +
  coord_flip() -> regret1

total %>% 
  # Stats
  filter(env == "BanditTwoHigh10-v0") %>% 
  group_by(agents, env) %>% 
  summarise(M = median(regrets), SD=mad(regrets)) %>% 
  # Plots
  ggplot(aes(x=agents, y=M, color=agents)) +
  geom_point(alpha=1, size=1.5) +
  geom_linerange(aes(ymin=M-SD, ymax=M+SD), width=.4) +
  geom_text(x=5, y=2, label="II", color="black") +
  theme_classic() +
  theme(legend.position="none",
        plot.tag = element_text(size=14, face="bold"),
        plot.margin = margin(.1, .1, .1, .1, "cm")) +
  geom_hline(aes(yintercept=0), color="black", size=.2) +
  scale_color_manual(
    values=rev(c("darkorchid4", "mediumpurple3", "mediumpurple1", "steelblue3", "steelblue1", "grey"))) +
  labs(x=" ", y=" ") +
  scale_y_log10(
    breaks = trans_breaks("log10", function(x) 10^as.integer(x)),
    labels = trans_format("log10", math_format(10^.x))
  ) +
  coord_flip() -> regret2

total %>% 
  # Stats
  filter(env == "BanditHardAndSparse10-v0") %>% 
  group_by(agents, env) %>% 
  summarise(M = median(regrets), SD=mad(regrets)) %>% 
  # Plots
  ggplot(aes(x=agents, y=M, color=agents)) +
  geom_point(alpha=1, size=1.5) +
  geom_linerange(aes(ymin=M-SD, ymax=M+SD), width=.4) +
  geom_text(x=5, y=2, label="III", color="black") +
  theme_classic() +
  theme(legend.position="none", 
        plot.tag = element_text(size=14, face="bold"),
        plot.margin = margin(.1, .1, .1, .1, "cm")) +
  labs(x=" ", y=" ") +
  geom_hline(aes(yintercept=0), color="black", size=.2) +
  scale_color_manual(
    values=rev(c("darkorchid4", "mediumpurple3", "mediumpurple1", "steelblue3", "steelblue1", "grey"))) +
  scale_y_log10(
    breaks = trans_breaks("log10", function(x) 10^as.integer(x)),
    labels = trans_format("log10", math_format(10^.x))
  ) +
  coord_flip() -> regret3

total %>% 
  # Stats
  filter(env == "BanditUniform121-v0") %>% 
  group_by(agents, env) %>% 
  summarise(M = median(regrets), SD=mad(regrets)) %>% 
  # Plots
  ggplot(aes(x=agents, y=M, color=agents)) +
  geom_point(alpha=1, size=1.5) +
  geom_linerange(aes(ymin=M-SD, ymax=M+SD), width=.4) +
  geom_text(x=5, y=3.5, label="IV", color="black") +
  theme_classic() +
  theme(legend.position="none",
        plot.tag = element_text(size=14, face="bold"),
        plot.margin = margin(.1, .1, .1, .1, "cm")) +
  labs(x=" ", y="Total regret") +
  geom_hline(aes(yintercept=0), color="black", size=.2) +
  scale_color_manual(
    values=rev(c("darkorchid4", "mediumpurple3", "mediumpurple1", "steelblue3", "steelblue1", "grey"))) +
  scale_y_log10(
    breaks = trans_breaks("log10", function(x) 10^as.integer(x)),
    labels = trans_format("log10", math_format(10^.x))
  ) +
  coord_flip() -> regret4

# Test plot for panels (full Fig built below)
grid.arrange(regret1, regret2, regret3, regret4, nrow=4)
```

## Subfig - reward
```{r, fig.width=1.2, fig.height=2}
# ------------------------------------------------------------------------
# Build Reward panels 
total %>% 
  # Stats
  filter(env == "BanditOneHigh10-v0") %>% 
  group_by(agents, env) %>% 
  summarise(M = median(total_R), SD=mad(total_R)) %>% 
  # Plots
  ggplot(aes(x=agents, y=M, color=agents)) +
  geom_point(alpha=1, size=1.5) +
  geom_linerange(aes(ymin=M-SD, ymax=M+SD), width=.4) +
  theme_classic() +
  theme(legend.position="none",
        axis.text.y=element_blank(),
        plot.tag = element_text(size=14, face="bold"),
        plot.margin = margin(.1, .4, .1, .1, "cm")) +
  labs(x=" ", y=" ") +
  geom_hline(aes(yintercept=max(M)), color="black", size=.2) +
  scale_color_manual(
    values=rev(c("darkorchid4", "mediumpurple3", "mediumpurple1", "steelblue3", "steelblue1", "grey"))) +
  scale_y_log10(
    limits=c(100, 1000),
    breaks = trans_breaks("log10", function(x) 10^round(x,0)),
    labels = trans_format("log10", math_format(10^.x))
  ) +
  coord_flip() -> reward1

total %>% 
  # Stats
  filter(env == "BanditTwoHigh10-v0") %>% 
  group_by(agents, env) %>% 
  summarise(M = median(total_R), SD=mad(total_R)) %>% 
  # Plots
  ggplot(aes(x=agents, y=M, color=agents)) +
  geom_point(alpha=1, size=1.5) +
  geom_linerange(aes(ymin=M-SD, ymax=M+SD), width=.4) +
  theme_classic() +
  theme(legend.position="none",
        axis.text.y=element_blank(),
        plot.tag = element_text(size=14, face="bold"),
        plot.margin = margin(.1, .4, .1, .1, "cm")) +
  geom_hline(aes(yintercept=max(M)), color="black", size=.2) +
  scale_color_manual(
    values=rev(c("darkorchid4", "mediumpurple3", "mediumpurple1", "steelblue3", "steelblue1", "grey"))) +
  scale_y_log10(
    limits=c(100, 1000),
    breaks = trans_breaks("log10", function(x) 10^round(x,0)),
    labels = trans_format("log10", math_format(10^.x))
  ) +
  labs(x=" ", y=" ") +
  coord_flip() -> reward2

total %>% 
  # Stats
  filter(env == "BanditHardAndSparse10-v0") %>% 
  group_by(agents, env) %>% 
  summarise(M = median(total_R), SD=mad(total_R)) %>% 
  # Plots
  ggplot(aes(x=agents, y=M, color=agents)) +
  geom_point(alpha=1, size=1.5) +
  geom_linerange(aes(ymin=M-SD, ymax=M+SD), width=.4) +
  theme_classic() +
  theme(legend.position="none", 
        axis.text.y=element_blank(),
        plot.tag = element_text(size=14, face="bold"),
        plot.margin = margin(.1, .4, .1, .1, "cm")) +
  labs(x=" ", y=" ") +
  geom_hline(aes(yintercept=max(M)), color="black", size=.2) +
  scale_color_manual(
    values=rev(c("darkorchid4", "mediumpurple3", "mediumpurple1", "steelblue3", "steelblue1", "grey"))) +
  scale_y_log10(
    limits=c(100, 1000),
    breaks = trans_breaks("log10", function(x) 10^round(x,0)),
    labels = trans_format("log10", math_format(10^.x))
  ) +
  coord_flip() -> reward3

total %>% 
  # Stats
  filter(env == "BanditUniform121-v0") %>% 
  group_by(agents, env) %>% 
  summarise(M = median(total_R), SD=mad(total_R)) %>% 
  # Plots
  ggplot(aes(x=agents, y=M, color=agents)) +
  geom_point(alpha=1, size=1.5) +
  geom_linerange(aes(ymin=M-SD, ymax=M+SD), width=.4) +
  theme_classic() +
  theme(legend.position="none",
        axis.text.y=element_blank(),
        plot.tag = element_text(size=14, face="bold"),
        plot.margin = margin(.1, .5, .1, .1, "cm")) +
  labs(x=" ", y="Total reward") +
  geom_hline(aes(yintercept=max(M)), color="black", size=.2) +
  scale_color_manual(
    values=rev(c("darkorchid4", "mediumpurple3", "mediumpurple1", "steelblue3", "steelblue1", "grey"))) +
  scale_y_log10(
    limits=c(100, 100000),
    breaks = trans_breaks("log10", function(x) 10^as.integer(x)),
    labels = trans_format("log10", math_format(10^.x))
  ) +
  coord_flip() -> reward4

# Test plot for panels (full Fig built below)
grid.arrange(reward1, reward2, reward3, reward4, nrow=4)
```

## Build
```{r, eval=FALSE, fig.width=1.9, fig.height=2.8}
# Build Fig 2
# Uses Regret and Reward panels created above

head1 <- textGrob("Agent performance", vjust=0, gp = gpar(fontsize = 13))
y1 <- textGrob("Agent", vjust=2, rot=90, gp =  gpar(fontsize = 12))

plot_grid <- rbind(
  c(10, rep(9, 13)),
  c(10, rep(1, 7), rep(5, 6)),
  c(10, rep(1, 7), rep(5, 6)),
  c(10, rep(1, 7), rep(5, 6)),
  c(10, rep(1, 7), rep(5, 6)),
  c(10, rep(2, 7), rep(6, 6)),
  c(10, rep(2, 7), rep(6, 6)),
  c(10, rep(2, 7), rep(6, 6)),
  c(10, rep(2, 7), rep(6, 6)),
  c(10, rep(3, 7), rep(7, 6)),
  c(10, rep(3, 7), rep(7, 6)),
  c(10, rep(3, 7), rep(7, 6)),
  c(10, rep(3, 7), rep(7, 6)),
  c(10, rep(4, 7), rep(8, 6)),
  c(10, rep(4, 7), rep(8, 6)),
  c(10, rep(4, 7), rep(8, 6)),
  c(10, rep(4, 7), rep(8, 6))
)

fig3 <- grid.arrange(
  regret1, regret2, regret3, regret4,  
  reward1, reward2, reward3, reward4,  
  head1, y1,
  layout_matrix=plot_grid)

ggsave("img/fig3.png", fig3, width=1.9*2, height=2.8*2, dpi = 300)
```


# Supplementary 
## Subfig1 - World model and distance
```{r, fig.width=2.2, fig.height=1, message=FALSE}
# Set seed for consisten Fig.
set.seed(3124)

# ------------------------------------------------------------
# World model
# Build an empty memory
ps <- runif(10)
ps <- ps / sum(ps)

ps[7] <- ps[7]+.5
ps <- ps / sum(ps)
example_memory <- data.frame(arms=1:10, p_reward=ps)

example_memory %>% 
  ggplot(aes(x=as.factor(arms), y=p_reward)) +
  geom_bar(stat="identity", width=0.6, position = "dodge", fill="darkorchid4") +
  theme_classic() +
  theme(plot.tag = element_text(size=14, face="bold")) +
  labs(x="Arm", y="Reward prob.", title="World model", tag="A") +
  scale_y_continuous(breaks=c(0, 0.25, 0.5), limits = c(0, 0.5)) -> memory1

# ------------------------------------------------------------
# Distance
# Build an empty memory
ps <- runif(10)
ps <- ps / sum(ps)
distance_memory <- data.frame(arms=1:10, p_reward=ps)
distance_memory$memory <- rep("M_0", nrow(distance_memory))

del_p <- 0.1
n_samples <- 10000
Es <- NULL
dPs <- NULL
for(t in 1:n_samples){
  qs <- ps
  qs[7] <- qs[7] + del_p
  qs <- qs / sum(qs)  
  
  E <- kl_divergence(qs, ps)
  
  Es <- c(Es, E)
  dPs <- c(dPs, sum(abs(qs - ps)))
  
  ps <- qs
}

flux <- data.frame(E=Es, dP=dPs)

xmax <- max(flux$dP)

flux %>% 
  ggplot(aes(dP, E)) +
  geom_line(size=1.25, color="darkorchid4") +
  theme_classic() +
  theme(plot.tag = element_text(size=14, face="bold")) +
  labs(x="Total change in prob.", y="KL", title="Distance", tag="B") -> distance1

# ------------------------------------------------------
# BUILD
subfig1 <- grid.arrange(memory1, distance1, nrow=1)
ggsave("img/subfig1.png", subfig1, width=2.2*2, height=1.0*2)
```


## Subfig2 - Specificity and KL
```{r, fig.width=2.2, fig.height=2}
# Set seed for consisten Fig.
set.seed(3124)

# Build an empty memory
ps <- runif(10)
ps <- ps / sum(ps)

memory0 <- data.frame(arms=1:10, p_reward=ps)
memory0$memory <- rep("initial", nrow(memory0))

# global
ps_g <- ps
ps_g[7] <- ps_g[7]+ps[8]
ps_g <- ps_g / sum(ps_g)

global <- data.frame(arms=1:10, p_reward=ps_g)
global$memory <- rep("global", nrow(global))
global <- full_join(memory0, global)
global$memory <- factor(global$memory, levels=c("initial", "global"))
                           
# local
ps_l <- ps
ps_l[7] <- ps_l[7]+ps[8]
ps_l[8] <- 0.0001
ps_1 <- ps_l / sum(ps_l)

local <- data.frame(arms=1:10, p_reward=ps_l)
local$memory <- rep("local", nrow(local))
local <- full_join(memory0, local)
local$memory <- factor(local$memory, levels=c("initial", "local"))


Eg <- kl_divergence(
  filter(global, memory == "global")$p_reward,
  filter(global, memory == "initial")$p_reward)

El <- kl_divergence(
  filter(local, memory == "local")$p_reward,
  filter(local, memory == "initial")$p_reward)

Edf <- data.frame(memory=c("local", "global"), E=c(El, Eg))

global %>% 
  ggplot(aes(x=as.factor(arms), y=p_reward, fill=memory)) +
  geom_bar(stat="identity", width=0.6, position = "dodge") +
  geom_point(aes(x=7, y=0.5), shape=18, size=0.5, show.legend = FALSE) +
  theme_classic() +
  theme(legend.position = "none", plot.tag = element_text(size=14, face="bold")) +
  ggtitle("Global change") +
  labs(x=" ", y="Reward prob.", tag="A") +
  scale_fill_manual(values = c("grey", "mediumpurple1")) +
  scale_y_continuous(breaks=c(0, 0.25, 0.5), limits = c(0, 0.5)) -> pg

local %>% 
  ggplot(aes(x=as.factor(arms), y=p_reward, fill=memory)) +
  geom_bar(stat="identity", width=0.6, position = "dodge") +
  geom_point(aes(x=7, y=0.5), shape=18, size=0.5, show.legend = FALSE) +
  geom_point(aes(x=8, y=0.5), shape=18, size=0.5, show.legend = FALSE) +
  theme_classic() +
  theme(legend.position = "none", plot.tag = element_text(size=14, face="bold")) +
  ggtitle("Local change") +
  labs(x="Arm", y="Reward prob.", tag="B") +
  scale_fill_manual(values = c("grey", "mediumpurple4")) +
  scale_y_continuous(breaks=c(0, 0.25, 0.5), limits = c(0, 0.5)) -> pl

Edf %>% 
  ggplot(aes(x=memory, y=E, fill=memory)) +
  geom_bar(stat="identity", width=0.6) +
  theme_classic() +
  theme(legend.position = "none", plot.tag = element_text(size=14, face="bold")) +
  scale_fill_manual(values = c("mediumpurple1", "mediumpurple4")) +
  labs(y="KL", x=" ", tag="C") -> pe

plot_grid <- rbind(
  c(1, 3),
  c(1, 3),
  c(1, 3),
  c(1, 3),
  c(1, 3),
  c(1, 3),
  c(1, 3),
  c(1, 3),
  c(NA, 3),
  c(2, 3),
  c(2, 3),
  c(2, 3),
  c(2, 3),
  c(2, 3),
  c(2, 3),
  c(2, 3),
  c(2, 3)
)
subfig3 <- grid.arrange(pg, pl, pe, layout_matrix=plot_grid)

ggsave("img/subfig2.png", subfig3, width=2.2*2, height=2*2)
```

## Subfig3 - Value dynamics
```{r, eval=FALSE, fig.height=3.25, fig.width=1.2}
value_traces %>% 
  filter(n==3) %>% 
  ggplot(aes(x=episodes, y=log(values_R))) +
  geom_point(size=0.01, color="black") + 
  geom_point(aes(x=episodes, y=log(values_E)), size=0.1, color="darkorchid4") +
  geom_hline((aes(yintercept=log(0.0053))), color="darkorchid4", alpha=0.2) +
  labs(x="Trial", y="Value", tag="A", title="Dual value") + 
  theme_classic() +
  theme(plot.tag = element_text(size=14, face="bold")) -> ex1

value_traces %>% 
  filter(n==3) %>%
  ggplot(aes(x=episodes, y=arms+1)) +
  geom_point(size=0.01, color="black") + 
  labs(x="Trial", y="Arm", tag="B", title="Dual value") +
  scale_y_continuous(breaks=seq(1, 10), labels=c(1, rep(" ", 8), 10)) +
  theme_classic() +
  theme(plot.tag = element_text(size=14, face="bold")) +
  geom_hline(aes(yintercept=8), color="red", size=.25, alpha=0.95) +
  theme() -> ex2

# softbeta
example_traces %>% 
  filter(env == "BanditOneHigh10-v0", agents=="softbeta") %>% 
  filter(n==3) %>%
  ggplot(aes(x=episodes, y=arms+1)) +
  geom_point(size=0.01, color="black") + 
  labs(x="Trial", y="Arm", tag="C", title="Bayesian") +
  scale_y_continuous(breaks=seq(1, 10), labels=c(1, rep(" ", 8), 10)) +
  theme_classic() +
  theme(plot.tag = element_text(size=14, face="bold")) +
  geom_hline(aes(yintercept=8), color="red", size=.25, alpha=0.95) +
  theme() -> ex3

# epsilon
example_traces %>% 
  filter(env == "BanditOneHigh10-v0", agents=="epsilon") %>% 
  filter(n==4) %>%
  ggplot(aes(x=episodes, y=arms+1)) +
  geom_point(size=0.01, color="black") + 
  labs(x="Trial", y="Arm", tag="D", title="E-greedy") +
  scale_y_continuous(breaks=seq(1, 10), labels=c(1, rep(" ", 8), 10)) +
  theme_classic() +
  theme(plot.tag = element_text(size=14, face="bold")) +
  geom_hline(aes(yintercept=8), color="red", size=.25, alpha=0.95) +
  theme() -> ex4

head1 <- textGrob("Exploration in Bandit I", vjust=0.7, gp = gpar(fontsize = 13))

plot_grid <- rbind(
  c(5, 5),
  c(1, 1),
  c(1, 1),
  c(1, 1),
  c(1, 1),
  c(1, 1),
  c(1, 1),
  c(1, 1),
  c(1, 1),
  c(1, 1),
  c(1, 1),
  c(1, 1),
  c(1, 1),
  c(2, 2),
  c(2, 2),
  c(2, 2),
  c(2, 2),
  c(2, 2),
  c(2, 2),
  c(2, 2),
  c(2, 2),
  c(3, 3),
  c(3, 3),
  c(3, 3),
  c(3, 3),
  c(3, 3),
  c(3, 3),
  c(3, 3),
  c(3, 3),
  c(4, 4),
  c(4, 4),
  c(4, 4),
  c(4, 4),
  c(4, 4),
  c(4, 4),
  c(4, 4),
  c(4, 4)
)
subfig4 <- grid.arrange(ex1, ex2, ex3, ex4, head1, layout_matrix=plot_grid)
ggsave("img/subfig3.png", subfig4, width=1.2*2, height=3.25*2)
```


