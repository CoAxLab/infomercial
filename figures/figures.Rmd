---
title: "Figures"
output: html_notebook
---

```{r}
library(ggplot2)
library(tidyr)
library(dplyr)
library(gridExtra)
library(grid)
library(readr)
library(latex2exp)
```


# Load data
```{r, echo=FALSE, message=FALSE}
data_path <- "~/Code/infomercial/data/"

# Load example traces
example_traces <- rbind(
  read_csv(paste(data_path, "example_traces_epsilon_BanditOneHigh10-v0.csv", sep="")),
  read_csv(paste(data_path, "example_traces_eta_BanditOneHigh10-v0.csv", sep=""))
)

# Load all data
traces <- NULL
total <- NULL
critic <- NULL
bandit <- NULL
bandit_names <- c("BanditOneHigh10-v0", "BanditTwoHigh10-v0", "BanditUniform121-v0", "BanditHardAndSparse10-v0")
for(bandit_name in bandit_names){
  tmp <- read_csv(paste(data_path, "table_traces_", bandit_name, ".csv", sep=""))
  tmp$env <- rep(bandit_name, nrow(tmp))
  traces <- rbind(traces, tmp)
  
  tmp <- read_csv(paste(data_path, "table_total_", bandit_name, ".csv", sep=""))
  tmp$env <- rep(bandit_name, nrow(tmp))
  total <- rbind(total, tmp)
  
  tmp <- read_csv(paste(data_path, "table_critic_", bandit_name, ".csv", sep=""))
  tmp$env <- rep(bandit_name, nrow(tmp))
  critic <- rbind(critic, tmp)
  
  tmp <- read_csv(paste(data_path, "table_bandit_", bandit_name, ".csv", sep=""))
  tmp$env <- rep(bandit_name, nrow(tmp))
  bandit <- rbind(bandit, tmp)
}

# Set agent order
traces$agents <- factor(traces$agents, 
                        levels=rev(c("eta", "beta", "softbeta", "epsilon", "anneal-epsilon", "random")))
total$agents <- factor(total$agents, 
                       levels=rev(c("eta", "beta", "softbeta", "epsilon", "anneal-epsilon", "random")))
critic$agents <- factor(critic$agents, 
                        levels=rev(c("eta", "beta", "softbeta", "epsilon", "anneal-epsilon", "random")))

rm(tmp)
```

# Fig 1
load as grob, and add labels.

# Fig 2
## Subfig 1
```{r, fig.width=0.8}
bandit %>% 
  filter(env == "BanditOneHigh10-v0") %>% 
  ggplot(aes(x=as.factor(arms+1), y=p_reward)) +
  geom_bar(stat="identity", width=0.8) +
  theme_classic() +
  lims(y=c(0,1)) +
  labs(x="Arm", y=TeX("$P_R$")) -> sub1

print(sub1)
```

## Subfig 2
```{r, fig.width=1.2, fig.height=0.7}
t1 <- textGrob(TeX("$M = (p_.1, p_2,..., p_a)$"), 
               just = "right", hjust = 0.3)
t2 <- textGrob(TeX("$p_a = \\frac{N_R}{N_{trial}$"), 
               just = "right", hjust = 0.3)
t3 <- textGrob(TeX("KL = \\sum_{a=1}^K P_{t+1}^a log ( \\frac{P_{t}^a}{P_{t+1}^a} )$"), 
               just = "right", hjust = 0.5)

sub2 <- grid.arrange(t1, t2, t3, nrow=3)
```

## Subfig 3
```{r, fig.width=1.2, fig.height=1.2}
# Build an empty memory
memory0 <- data.frame(arms=1:10, p_reward=rep(0.2, 10))

bandit %>% 
  filter(env == "BanditOneHigh10-v0") %>% select(-env) -> banditonehigh10

# Simulate a learned memory
num_trials <- 100
memoryInf <- NULL
for (arm in 1:10) {
  # sample based on 'BanditOneHigh10'
  Nr <- rbinom(1, num_trials, banditonehigh10$p_reward[arm])
  p_reward = Nr / num_trials
  row <- c(arm, p_reward)
  
  memoryInf <- rbind(memoryInf, row)
}
memoryInf <- as.data.frame(memoryInf)
colnames(memoryInf) <- c("arms", "p_reward")

memory0 %>% 
  ggplot(aes(x=as.factor(arms), y=p_reward)) +
  geom_bar(stat="identity", width=0.8) +
  theme_classic() +
  labs(x=" ", y=" ") +
  lims(y=c(0,1)) +
  ggtitle(TeX("$M_{t=1}$")) -> b1

memoryInf %>% 
  ggplot(aes(x=as.factor(arms), y=p_reward)) +
  geom_bar(stat="identity", width=0.8) +
  theme_classic() +
  ggtitle(TeX("$M_{t=100}$")) +
  labs(x="Arm", y=" ") +
  lims(y=c(0,1)) -> b2

ylabel <- textGrob(TeX("$P_R$"), rot=90, vjust=1, gp = gpar(fontsize = 12))

plot_grid <- rbind(
  c(3, 1, 1, 1, 1, 1),
  c(3, 1, 1, 1, 1, 1),
  c(3, 2, 2, 2, 2, 2),
  c(3, 2, 2, 2, 2, 2))

sub3 <- grid.arrange(b1, b2, ylabel, layout_matrix=plot_grid)
```

## Subfig 4
```{r, fig.width=4, fig.height=1.4}
example_traces %>% 
  filter(n==2, episodes < 100) %>% 
  ggplot(aes(x=episodes, as.factor(arms))) +
  geom_point(size=.5) +
  facet_grid(agents~.) + 
  labs(y="Arm") +
  theme_classic() + 
  theme(
    strip.background = element_blank(),
    strip.text.y = element_blank()
  ) -> z1

example_traces %>% 
  filter(n==2, episodes < 100) %>% 
  ggplot(aes(x=episodes, log(values_R))) +
  geom_point(color="darkgrey", size=.5) +
  geom_point(aes(x=episodes, log(values_E)), color="purple", size=.5) +
  facet_grid(agents~.) + 
  labs(y="log Value") +
  theme_classic() +
  theme(
    strip.background = element_blank(),
    strip.text.y = element_blank()
  ) -> z2

example_traces %>% 
  filter(n==54, episodes < 100) %>% 
  ggplot(aes(x=episodes, regrets)) +
  geom_point(color="black", size=.5) +
  facet_grid(agents~.) + 
  labs(y="Regret") +
  geom_hline(yintercept = 0, size=.2) +
  theme_classic() +
  theme(
    strip.background = element_blank(),
    strip.text.y = element_blank()
  ) -> z3

example_traces %>% 
  filter(n==54, episodes < 100) %>% 
  group_by(agents) %>% 
  mutate(total_R = cumsum(scores_R)) %>% 
  ggplot(aes(x=episodes, total_R)) +
  geom_point(color="black", size=.5) +
  facet_grid(agents~.) + 
  labs(y="Total R") +
  geom_hline(yintercept = 0, size=.2) +
  theme_classic() +
  theme(
    strip.background = element_blank(),
    strip.text.y = element_blank()
  ) -> z4

agent1 <- textGrob("epsilon", vjust=-.2, gp = gpar(fontsize = 12))
agent2 <- textGrob("eta", vjust=-.2, gp = gpar(fontsize = 12))

plot_grid <- rbind(
  c(1, 1, 2, 2, 3),
  c(1, 1, 2, 2, 4))
  
sub4 <- grid.arrange(z1, z2, agent1, agent2, layout_matrix=plot_grid)
```
## Build
```{r, fig.height=1.1, fig.width=6}
task1 <- textGrob("Task", vjust=0, gp = gpar(fontsize = 12))
mem1 <- textGrob("Memory", vjust=0, gp = gpar(fontsize = 12))
ex1 <- textGrob("Exploration", vjust=0, gp = gpar(fontsize = 12))

plot_grid <- rbind(
  c(4, 4, 5, 5, 6, 6, 6, 6, 6),
  c(1, 1, 2, 2, 3, 3, 3, 3, 3),
  c(1, 1, 2, 2, 3, 3, 3, 3, 3),
  c(1, 1, 2, 2, 3, 3, 3, 3, 3),
  c(NA, NA, NA, NA, 3, 3, 3, 3, 3))

grid.arrange(sub1, sub2, sub4, task1, mem1, ex1, layout_matrix=plot_grid)
```

# Fig 3
## Subfig 1
```{r, fig.width=3, fig.height=2.2}
# ------------------------------------------------------
# Regret
total %>% 
  filter(env == "BanditOneHigh10-v0") %>% 
  # filter(agents != "random") %>% 
  group_by(agents, env) %>% 
  summarise(M = median(regrets), SD=mad(regrets)) %>% 
  ggplot(aes(x=agents, y=M, color=agents)) +
  geom_point(alpha=.9) +
  geom_errorbar(aes(ymin=M-SD, ymax=M+SD), width=.1) +
  theme_classic() +
  # theme(legend.position=c(-0.7, 0),
  #       legend.direction="vertical",
  #       legend.key.size = unit(.5, "cm"),
  #       legend.key.height=unit(0.3,"cm"),
  #       # plot.margin = margin(.2, .5, .2, .2, "cm"),
  #       legend.background = element_rect(colour ="black"),
  #       axis.text.y=element_blank(),
  #       plot.margin = margin(.1, .1, .1, .1, "cm")) +
  theme(legend.position="none",
        # axis.text.y=element_blank(),
        plot.margin = margin(.1, .1, .1, .1, "cm")) +
  labs(x=" ", y=" ") +
  scale_y_continuous(breaks=c(0, 125, 250), limits = c(0, 300)) +
  geom_hline(aes(yintercept=min(M)), color="black", size=.2) +
  scale_color_manual(
    "Agent",
    values=rev(c("darkorchid4", "mediumpurple3", "mediumpurple1", "steelblue3", "steelblue1", "grey"))) +
  coord_flip() -> c1

total %>% 
  filter(env == "BanditTwoHigh10-v0") %>% 
  # filter(agents != "random") %>% 
  group_by(agents, env) %>% 
  summarise(M = median(regrets), SD=mad(regrets)) %>% 
  ggplot(aes(x=agents, y=M, color=agents)) +
  geom_point(alpha=.9) +
  geom_errorbar(aes(ymin=M-SD, ymax=M+SD), width=.1) +
  theme_classic() +
  theme(legend.position="none",
        # axis.text.y=element_blank(),
        plot.margin = margin(.1, .1, .1, .1, "cm")) +
  scale_y_continuous(breaks=c(0, 100, 200), limits = c(0, 250)) +
  geom_hline(aes(yintercept=min(M)), color="black", size=.2) +
  scale_color_manual(
    values=rev(c("darkorchid4", "mediumpurple3", "mediumpurple1", "steelblue3", "steelblue1", "grey"))) +
  labs(x=" ", y=" ") +
  coord_flip() -> c2

total %>% 
  filter(env == "BanditUniform121-v0") %>% 
  # filter(agents != "random") %>% 
  group_by(agents, env) %>% 
  summarise(M = median(regrets), SD=mad(regrets)) %>% 
  ggplot(aes(x=agents, y=M, color=agents)) +
  geom_point(alpha=.9) +
  geom_errorbar(aes(ymin=M-SD, ymax=M+SD), width=.1) +
  theme_classic() +
  theme(legend.position="none",
        # axis.text.y=element_blank(),
        plot.margin = margin(.1, .1, .1, .1, "cm")) +
  labs(x=" ", y=" ") +
  scale_y_continuous(breaks=c(0, 30000, 60000), limits = c(0, 61000)) +
  geom_hline(aes(yintercept=min(M)), color="black", size=.2) +
  scale_color_manual(
    values=rev(c("darkorchid4", "mediumpurple3", "mediumpurple1", "steelblue3", "steelblue1", "grey"))) +
  coord_flip() -> c3

total %>% 
  filter(env == "BanditHardAndSparse10-v0") %>% 
  # filter(agents != "random") %>% 
  group_by(agents, env) %>% 
  summarise(M = median(regrets), SD=mad(regrets)) %>% 
  ggplot(aes(x=agents, y=M, color=agents)) +
  geom_point(alpha=.9) +
  geom_errorbar(aes(ymin=M-SD, ymax=M+SD), width=.1) +
  theme_classic() +
  theme(legend.position="none", 
        # axis.text.y=element_blank(),
        plot.margin = margin(.1, .1, .1, .1, "cm")) +
  labs(x=" ", y="Total regret") +
  scale_y_continuous(breaks=c(0, 2500, 5000), limits = c(0, 5500)) +
  geom_hline(aes(yintercept=min(M)), color="black", size=.2) +
  scale_color_manual(
    values=rev(c("darkorchid4", "mediumpurple3", "mediumpurple1", "steelblue3", "steelblue1", "grey"))) +
  coord_flip() -> c4

# ------------------------------------------------------
# total R
total %>% 
  filter(env == "BanditOneHigh10-v0") %>% 
  group_by(agents, env) %>% 
  summarise(M = median(total_R), SD=mad(total_R)) %>% 
  ggplot(aes(x=agents, y=M, color=agents)) +
  geom_point(alpha=.9) +
  geom_errorbar(aes(ymin=M-SD, ymax=M+SD), width=.1) +
  theme_classic() +
  theme(legend.position="none",
        axis.text.y=element_blank(),
        plot.margin = margin(.1, .4, .1, .1, "cm")) +
  labs(x=" ", y=" ") +
  scale_y_continuous(breaks=c(0, 200, 400), limits = c(0, 450)) +
  geom_hline(aes(yintercept=max(M)), color="black", size=.2) +
  scale_color_manual(
    values=rev(c("darkorchid4", "mediumpurple3", "mediumpurple1", "steelblue3", "steelblue1", "grey"))) +
  coord_flip() -> d1

total %>% 
  filter(env == "BanditTwoHigh10-v0") %>% 
  group_by(agents, env) %>% 
  summarise(M = median(total_R), SD=mad(total_R)) %>% 
  ggplot(aes(x=agents, y=M, color=agents)) +
  geom_point(alpha=.9) +
  geom_errorbar(aes(ymin=M-SD, ymax=M+SD), width=.1) +
  theme_classic() +
  theme(legend.position="none",
        axis.text.y=element_blank(),
        plot.margin = margin(.1, .4, .1, .1, "cm")) +
  scale_y_continuous(breaks=c(0, 200, 400), limits = c(0, 500)) +
  geom_hline(aes(yintercept=max(M)), color="black", size=.2) +
  scale_color_manual(
    values=rev(c("darkorchid4", "mediumpurple3", "mediumpurple1", "steelblue3", "steelblue1", "grey"))) +
  labs(x=" ", y=" ") +
  coord_flip() -> d2

options(scipen=1000000)
total %>% 
  filter(env == "BanditUniform121-v0") %>% 
  group_by(agents, env) %>% 
  summarise(M = median(total_R), SD=mad(total_R)) %>% 
  ggplot(aes(x=agents, y=M, color=agents)) +
  geom_point(alpha=.9) +
  geom_errorbar(aes(ymin=M-SD, ymax=M+SD), width=.1) +
  theme_classic() +
  theme(legend.position="none",
        axis.text.y=element_blank(),
        plot.margin = margin(.1, .4, .1, .1, "cm")) +
  labs(x=" ", y=" ") +
  scale_y_continuous(breaks=c(0, 50000, 100000), limits = c(0, 100100)) +
  geom_hline(aes(yintercept=max(M)), color="black", size=.2) +
  scale_color_manual(
    values=rev(c("darkorchid4", "mediumpurple3", "mediumpurple1", "steelblue3", "steelblue1", "grey"))) +
  coord_flip() -> d3

total %>% 
  filter(env == "BanditHardAndSparse10-v0") %>% 
  group_by(agents, env) %>% 
  summarise(M = median(total_R), SD=mad(total_R)) %>% 
  ggplot(aes(x=agents, y=M, color=agents)) +
  geom_point(alpha=.9) +
  geom_errorbar(aes(ymin=M-SD, ymax=M+SD), width=.1) +
  theme_classic() +
  theme(legend.position="none", 
        axis.text.y=element_blank(),
        plot.margin = margin(.1, .4, .1, .1, "cm")) +
  labs(x=" ", y="Total reward") +
  scale_y_continuous(breaks=c(0, 1000, 2000), limits = c(0, 2100)) +
  geom_hline(aes(yintercept=max(M)), color="black", size=.2) +
  # ylim(c(0, 400)) +
  scale_color_manual(
    values=rev(c("darkorchid4", "mediumpurple3", "mediumpurple1", "steelblue3", "steelblue1", "grey"))) +
  coord_flip() -> d4

# -
ylabel <- textGrob("Agent", vjust=3, rot=90, gp = gpar(fontsize = 12))

row1 <- textGrob("One best", hjust=-0, vjust=0, gp = gpar(fontsize = 10))
row2 <- textGrob("Distractor", hjust=-0, vjust=0, gp = gpar(fontsize = 10))
row3 <- textGrob("Random 121", hjust=-0, vjust=0, gp = gpar(fontsize = 10))
row4 <- textGrob("Sparse", hjust=0, vjust=0, gp = gpar(fontsize = 10))

plot_grid <- rbind(
  c(9, 1, 1, 1, 1, 5, 5, 5), # 5, 10, 10, 10), 
  c(9, 2, 2, 2, 2, 6, 6, 6), # 6, 11, 11, 11), 
  c(9, 3, 3, 3, 3, 7, 7, 7), # 7, 12, 12, 12), 
  c(9, 4, 4, 4, 4, 8, 8, 8)) #, 8, 13, 13, 13)) 
  
sub1 <- grid.arrange(c1, c2, c3, c4, d1, d2, d3, d4, ylabel, layout_matrix=plot_grid)
```

## Subfig 2
```{r, fig.width=4, fig.height=2.2}
# Bandits
bandit %>% 
  filter(env == "BanditOneHigh10-v0") %>% 
  ggplot(aes(x=as.factor(arms+1), y=p_reward)) +
  geom_bar(stat="identity", width=1) +
  geom_point(aes(x=8, y=0.9), color="red") +
  theme_classic() +
  theme(axis.text.x=element_blank(), axis.ticks.x = element_blank()) +
  scale_y_continuous(breaks=c(0, 0.5, 1), limits = c(0, 1)) +
  labs(x=" ", y=" ") -> bandit1

bandit %>% 
  filter(env == "BanditTwoHigh10-v0") %>% 
  ggplot(aes(x=as.factor(arms+1), y=p_reward)) +
  geom_bar(stat="identity", width=1) +
  geom_point(aes(x=4, y=0.9), color="red") +
  theme_classic() +
  theme(axis.text.x=element_blank(), axis.ticks.x = element_blank()) +
  scale_y_continuous(breaks=c(0, 0.5, 1), limits = c(0, 1)) +
  labs(x=" ", y=" ") -> bandit2

bandit %>% 
  filter(env == "BanditUniform121-v0") %>% 
  ggplot(aes(x=as.factor(arms+1), y=p_reward)) +
  geom_bar(stat="identity", width=1) +
  geom_point(aes(x=55, y=0.9), color="red") +
  theme_classic() +
  theme(axis.text.x=element_blank(), axis.ticks.x = element_blank()) +
  scale_y_continuous(breaks=c(0, 0.5, 1), limits = c(0, 1)) +
  labs(x=" ", y=" ") -> bandit3

bandit %>% 
  filter(env == "BanditHardAndSparse10-v0") %>% 
  ggplot(aes(x=as.factor(arms+1), y=p_reward)) +
  geom_bar(stat="identity", width=1) +
  geom_point(aes(x=8, y=0.9), color="red") +
  theme_classic() +
  theme(axis.text.x=element_blank(), axis.ticks.x = element_blank()) +
  scale_y_continuous(breaks=c(0, 0.5, 1), limits = c(0, 1)) +
  labs(x="Arm", y=" ") -> bandit4

# -
xlabel <- textGrob("Arm", vjust=-1.5, gp = gpar(fontsize = 12))
ylabel <- textGrob(TeX("$P_R$"), hjust=-1, gp = gpar(fontsize = 12))

row1 <- textGrob("One best", hjust=0, vjust=0, gp = gpar(fontsize = 10, fontface="bold"))
row2 <- textGrob("Distractor", hjust=0, vjust=-.5, gp = gpar(fontsize = 10, fontface="bold"))
row3 <- textGrob("Random 121", hjust=0, vjust=-.5, gp = gpar(fontsize = 10, fontface="bold"))
row4 <- textGrob("Sparse", hjust=0, vjust=-.5, gp = gpar(fontsize = 10, fontface="bold"))

plot_grid <- rbind(
  c(6, 5, 1, 1, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA),
  c(6, 5, 1, 1, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA),
  c(6, 5, 1, 1, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA),
  c(7, 5, 2, 2, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA),
  c(7, 5, 2, 2, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA),
  c(7, 5, 2, 2, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA),
  c(8, 5, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3),
  c(8, 5, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3),
  c(8, 5, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3),
  c(9, 5, 4, 4, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA),
  c(9, 5, 4, 4, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA),
  c(9, 5, 4, 4, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA))
  # c(6, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5))
 
sub2 <- grid.arrange(bandit1, bandit2, bandit3, bandit4, ylabel, row1, row2, row3, row4, layout_matrix=plot_grid)
```


## Build
```{r, fig.width=6, fig.height=2.4}
task1 <- textGrob("Task", vjust=0, gp = gpar(fontsize = 10, fontface="bold"))
perf1 <- textGrob("Total return", vjust=0, gp =  gpar(fontsize = 10, fontface="bold"))

plot_grid <- rbind(
  c(NA, 3, 3, 3, 3, 3, 3, NA, 4, 4, 4),
  c(1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2),
  c(1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2),
  c(1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2),
  c(1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2),
  c(1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2),
  c(1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2),
  c(1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2),
  c(1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2),
  c(1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2),
  c(1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2),
  c(1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2),
  c(1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2),
  c(1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2)
  )

grid.arrange(sub2, sub1, task1, perf1, layout_matrix=plot_grid)
```