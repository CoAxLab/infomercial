---
title: "Figures - reward consistency"
output: html_notebook
---

# Load data
## Cached?
```{r, eval=FALSE}
load.image(file="performance.RData")
```

## New
From indivdual notebooks, for all bandit tasks.
```{r, warning=FALSE, message=FALSE, eval=FALSE}
library(knitr)
source(knitr::purl("task2_results.Rmd", quiet=TRUE))
source(knitr::purl("task3_results.Rmd", quiet=TRUE))
source(knitr::purl("task4_results.Rmd", quiet=TRUE))
source(knitr::purl("task5_results.Rmd", quiet=TRUE))
source(knitr::purl("task6_results.Rmd", quiet=TRUE))
source(knitr::purl("task7_results.Rmd", quiet=TRUE))

# Save
save.image(file="performance.RData")
```

# Vis
Est. reward deviance on the last episode
## Overall
```{r, fig.width=5, fig.height=5.0}
# Sum
result_task2 %>%  
  group_by(strategy, agent, param, run) %>% 
  summarise(total_R = last(total_R)) %>% 
  ungroup() %>% 
  group_by(strategy, agent) %>% 
  summarise(var_R = mad(total_R)) -> tmp
# Norm
tmp %>%
  group_by(agent, strategy) %>%
  mutate(var_R = var_R / min(tmp$var_R)) ->
  tmp2

# Sum
result_task3 %>%  
  group_by(strategy, agent, param, run) %>% 
  summarise(total_R = last(total_R)) %>% 
  ungroup() %>% 
  group_by(strategy, agent) %>% 
  summarise(var_R = mad(total_R)) -> tmp
# Norm
tmp %>%
  group_by(agent, strategy) %>%
  mutate(var_R = var_R / min(tmp$var_R)) ->
  tmp3

result_task4 %>%  
  group_by(strategy, agent, param, run) %>% 
  summarise(total_R = last(total_R)) %>% 
  ungroup() %>% 
  group_by(strategy, agent) %>% 
  summarise(var_R = mad(total_R)) -> tmp
# Norm
tmp %>%
  group_by(agent, strategy) %>%
  mutate(var_R = var_R / min(tmp$var_R)) ->
  tmp4

result_task5 %>%  
  group_by(strategy, agent, param, run) %>% 
  summarise(total_R = last(total_R)) %>% 
  ungroup() %>% 
  group_by(strategy, agent) %>% 
  summarise(var_R = mad(total_R)) -> tmp
# Norm
tmp %>%
  group_by(agent, strategy) %>%
  mutate(var_R = var_R / min(tmp$var_R)) ->
  tmp5

result_task6 %>%  
  group_by(strategy, agent, param, run) %>% 
  summarise(total_R = last(total_R)) %>% 
  ungroup() %>% 
  group_by(strategy, agent) %>% 
  summarise(var_R = mad(total_R)) -> tmp
# Norm
tmp %>%
  group_by(agent, strategy) %>%
  mutate(var_R = var_R / min(tmp$var_R)) ->
  tmp6

result_task7 %>%  
  group_by(strategy, agent, param, run) %>% 
  summarise(total_R = last(total_R)) %>% 
  ungroup() %>% 
  group_by(strategy, agent) %>% 
  summarise(var_R = mad(total_R)) -> tmp
# Norm
tmp %>%
  group_by(agent, strategy) %>%
  mutate(var_R = var_R / min(tmp$var_R)) ->
  tmp7


# todo = rest of tmps
# Join
bind_rows(tmp2, tmp3, tmp4, tmp5, tmp6, tmp7) %>%
  group_by(agent, strategy) %>%
  summarise(var_R = mad(var_R)) ->
  tmp

# -------------------------------------------------------------
# Our value
wsls_R <- filter(tmp, strategy == "WSLS")$var_R
random_R <-  filter(tmp, strategy == "Random")$var_R

tmp %>% 
  filter(agent != "Random") %>% 
  ggplot(aes(
    x = agent,
    y = var_R,
    color = factor(strategy)
  )) +
  geom_point(size=2) +
  geom_hline(aes(yintercept=wsls_R), 
             color="chartreuse4",
             size=0.4) +
  theme_pubr(base_size = 12, legend = "none") +
  scale_color_manual("", values = c("black", "darkgrey", "chartreuse4")) +
  labs(
    x = "",
    y = "Normalized reward deviance",
    subtitle = "Overall",
    title="Consistency of reward collection"
  ) +
  scale_y_continuous(limits = c(0, 5), breaks = c(0, 1, 2, 3, 4, 5)) +
  coord_flip() ->
  consistency

# -------------------------------------------------------------
# Save
name <- "img/consistency"
ggsave(paste(name, ".pdf", sep=""), plot=consistency, width = 5, height = 5)
```
