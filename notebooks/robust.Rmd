---
title: "Reanalysis of parameter robustness"
output: html_notebook
---

# Library
```{r, message=FALSE}
library(zoo)
library(ggplot2)
library(tidyr)
library(ggpubr)
library(patchwork)
library(tidyr)
library(dplyr)
library(gridExtra)
library(grid)
library(readr)
library(latex2exp)
# library(MASS) 
library(scales)
library(patchwork)
options(scipen=1000000)

# Load load_result and other helpful functions
source("utils.R")

# --- Main path to all data ---
data_path <- "~/Code/infomercial/data"
```

# Load data
## BanditOneHigh4
```{r, message=FALSE}
# -------------------------------------------------------------
task_name <- "BanditOneHigh4"
task_code <- 1

rank_names <- c(
  "exp595_sorted.csv", 
  # "exp596_sorted.csv", 
  # "exp597_sorted.csv", 
  "exp598_sorted.csv",
  "exp599_sorted.csv", 
  "exp600_sorted.csv", 
  "exp601_sorted.csv", 
  "exp602_sorted.csv", 
  "exp603_sorted.csv")

agent_names <- c(
  "Curiosity", 
  # "Random/Greedy", 
  # "Decay/Greedy", 
  "Reward", 
  "Bayesian", 
  "Novelty", 
  "Entropy", 
  "Count (EB)",
  "Count (UCB)"
)

class_names <- c(
  "Info. value",
  # "Random",
  # "Raandom",
  "Reward",
  "Mixed",
  "Mixed",
  "Mixed",
  "Mixed",
  "Mixed"
)

result_ranked4 <- NULL
for(i in 1:length(rank_names)){
  # Meta
  rank_name <- rank_names[i]
  agent_name <- agent_names[i]
  class_name <- class_names[i]
  
  # Get run?
  if (agent_name == "Random"){
    param_codes <- c(0)
    run_codes <- 1:100
  } else{
    param_codes <- 0:9
    run_codes <- 1:10
  }
  
  # Load and add meta
  tmp <- read_csv(paste(data_path, rank_name, sep="/"), show_col_types = FALSE)
  tmp$exp <- rank_name
  tmp$agent <- agent_name
  tmp$task <- task_name
  tmp$task_code <- task_code
  tmp$strategy <- class_name
  
  # Save
  result_ranked4 <- bind_rows(result_ranked4, tmp)
}

# Order factors for later vis
result_ranked4$agent <- factor(result_ranked4$agent, levels = agent_names)
result_ranked4$strategy <-
  factor(result_ranked4$strategy,
         levels = c("Info. value", "Reward", "Mixed"))
```

## BanditUniform121
```{r, message=FALSE}
# -------------------------------------------------------------
task_name <- "BanditUniform121"
task_code <- 2

rank_names <- c(
  "exp604_sorted.csv",
  # "exp605_sorted.csv",
  # "exp606_sorted.csv",
  "exp607_sorted.csv",
  "exp608_sorted.csv",
  "exp609_sorted.csv",
  "exp610_sorted.csv",
  "exp611_sorted.csv",
  "exp612_sorted.csv"
)

agent_names <- c(
  "Curiosity",
  # "Random/Greedy",
  # "Decay/Greedy",
  "Reward",
  "Bayesian",
  "Novelty",
  "Entropy",
  "Count (EB)",
  "Count (UCB)"
)

class_names <- c(
  "Info. value",
  # "Random",
  # "Raandom",
  "Reward",
  "Mixed",
  "Mixed",
  "Mixed",
  "Mixed",
  "Mixed"
)

result_ranked121 <- NULL
for (i in 1:length(rank_names)) {
  rank_name <- rank_names[i]
  agent_name <- agent_names[i]
  class_name <- class_names[i]
  if (agent_name == "Random") {
    param_codes <- c(0)
    run_codes <- 1:100
  } else{
    param_codes <- 0:9
    run_codes <- 1:10
  }
  
  tmp <-
    read_csv(paste(data_path, rank_name, sep = "/"), show_col_types = FALSE)
  
  tmp$exp <- rank_name
  tmp$agent <- agent_name
  tmp$task <- task_name
  tmp$task_code <- task_code
  tmp$strategy <- class_name
  
  result_ranked121 <- bind_rows(result_ranked121, tmp)
}

# Order factors for later vis
result_ranked121$agent <- factor(result_ranked121$agent, levels = agent_names)
result_ranked121$strategy <-
  factor(result_ranked121$strategy,
         levels = c("Info. value", "Reward", "Mixed"))
```

# Vis
## By rank
```{r, fig.width=6, fig.height=3.0}
max_R4 <- max(result_ranked4$total_R)

result_ranked4 %>%
  ggplot(aes(
    x = index + 1,
    y = total_R / max_R4,
    group = agent,
    color = strategy
  )) +
  geom_line(size = 1.2, alpha = 0.9) +
  labs(
    x = "Ranked exploration\nparameters",
    y = "Relative reward",
    subtitle = "Task 2 - Classic",
    tag = "a."
  ) +
  theme_pubr(base_size = 10, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(legend.position = "nane") +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.text.y = element_text(angle = 0, hjust = 1)) +
  theme(strip.text.y = element_blank()) +
  scale_color_manual("", values = c("chartreuse4", "darkgrey", "black")) +
  scale_x_continuous(breaks = c(0, 500, 1000)) +
  scale_y_continuous(limits = c(0, 1), breaks = c(0, 0.5, 1)) -> p1

# 121 armed
max_R121 <- max(result_ranked121$total_R)

result_ranked121 %>%
  ggplot(aes(
    x = index + 1,
    y = total_R / max_R121,
    group = agent,
    color = factor(strategy)
  )) +
  geom_line(size = 1.2, alpha = 0.9) +
  labs(
    x = "Ranked exploration\nparameters",
    y = "",
    subtitle = "Task 6 - High dimensional",
    tag = "b."
  ) +
  theme_pubr(base_size = 10, legend = "right") +
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.text.y = element_text(angle = 0, hjust = 1)) +
  scale_color_manual("Strategy", 
                     values = c("chartreuse4", "darkgrey", "black")) +
  scale_x_continuous(breaks = c(0, 500, 1000)) +
  scale_y_continuous(limits = c(0, 1), breaks = c(0, 0.5, 1)) -> p2

robust1 <- p1 + p2 +
  plot_annotation(title = "Robustness of exploration strategy")
print(robust1)

# ---
# Write pdf
name <- "img/robust1"
ggsave(paste(name, ".pdf", sep=""), plot=robust1, width = 6, height = 3)
```
## Summed over rank
```{r, fig.width=6, fig.height=2.5}
# Classic
result_ranked4 %>% 
  group_by(agent, strategy) %>% 
  summarise(total_R = sum(total_R)) -> 
  tmp1

tmp1 %>% 
  ggplot(aes(x=agent, y=total_R/max(tmp1$total_R), color=factor(strategy))) +
  geom_point() +
  scale_color_manual("", values = c("chartreuse4", "darkgrey", "black")) +
  labs(x="", y="Relative reward\n summed over\nparameters", tag="c.") +
  theme_classic() + 
  theme(legend.position = "nane") +
  scale_y_continuous(limits = c(0, 1), breaks = c(0, 1)) +
  coord_flip() -> p1
rm(tmp)

# High dimensional
result_ranked121 %>% 
  group_by(agent, strategy) %>% 
  summarise(total_R = sum(total_R)) -> 
  tmp2

tmp2 %>% 
  ggplot(aes(x=agent, y=total_R/max(tmp2$total_R), color=factor(strategy))) +
  geom_point() +
  scale_color_manual("", values = c("chartreuse4", "darkgrey", "black")) +
  labs(x="", y="Relative reward\n summed over\nparameters", tag="d.") +
  theme_classic() + 
  theme(legend.position = "nane") +
  scale_y_continuous(limits = c(0, 1), breaks = c(0, 1)) +
  coord_flip() -> p2

p1 + p2
```
