---
title: "Figures"
output: html_notebook
---

# Imports and paths
```{r, message=FALSE}
library(zoo)
library(ggplot2)
library(ggpubr)
library(patchwork)
library(tidyr)
library(dplyr)
library(gridExtra)
library(grid)
library(readr)
library(latex2exp)
library(MASS) 
library(scales)
library(patchwork)
options(scipen=1000000)

kl_divergence <- function(p, q) {
  sum(p * log(p/q))
}

# --- Main path to all data ---
data_path <- "~/Code/infomercial/data/"
```

# Figure 1 - Curiosity in a random world
## Load data
```{r message=FALSE, cache=TRUE}
# ---
exp_name <- "exp348"

actor_names <- c("DeterministicActor", "SoftmaxActor", "RandomActor")
better_names <- c("Deterministic", "Stochastic", "Random")

run_codes <- 1:100
file_names <- c("score_E", "action", "p_bests", "regret", "value_E", 
                "ties", "state", "total_E", "total_regret")

# ---
result348 <- NULL
for (i in 1:length(actor_names)){
  actor <- actor_names[i]
  better <- better_names[i]
  for (run in run_codes) {
    runtmp <- read_csv(paste(data_path, 
                             exp_name, 
                             actor,
                             paste("run", run, sep=""), 
                             paste(file_names[1], "csv", sep="."), sep="/"))    
    for (name in file_names[2:9]){
      tmp <- read_csv(paste(data_path, 
                            exp_name, 
                            actor,
                            paste("run", run, sep=""), 
                            paste(name, "csv", sep="."), sep="/"))  
      runtmp[[name]] <- tmp[[name]]
    }
    runtmp$run <- run
    runtmp$actor <- better
    runtmp$num_trials <- nrow(tmp)
    result348 <- bind_rows(result348, runtmp)  
  }
}

# --- Summarize the results ---
Ebias <- 4*1.38

result348 %>% 
  group_by(actor, run) %>% 
  summarise(
    total_E=last(total_E)/last(num_trials),
    total_regret=last(total_regret)/last(num_trials),
    num_steps=last(num_trials)
  ) %>% 
  ungroup() ->
summary348

# --
summary348$actor <- factor(summary348$actor, 
                           levels=c("Deterministic", "Stochastic", "Random"))

# ---
rm(tmp, runtmp, run, name, better, i)
```

## Sub 1 - action examples
```{r, fig.width=1.6, fig.height=2.2}
result348 %>% 
  filter(actor == "Deterministic") %>% 
  # filter(global_step < 40) %>%
  filter(run <= 12) %>% 
  ggplot(aes(x=global_step, y=action, color=actor)) +
  lims(x=c(0, 320)) +
  geom_line(size=0.3, alpha=1) +
  labs(x="", y="Choice", title="Deterministic") +
  facet_wrap(.~run, ncol=1) +
  theme_pubr(base_size = 8, legend = "none") +
  theme(strip.background = element_blank()) +
  scale_color_manual("Search", values=c("darkorchid4")) +
  theme(panel.spacing = unit(0.1, "lines")) +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") +
  theme(legend.box.background = element_rect(colour = "black", size=1)) +
  theme(plot.title = element_text(size = 6)) +
  theme(strip.text.y = element_text(angle = 0)) +
  theme(strip.text.x = element_blank()) +
  # theme(axis.text.x = element_blank()) +
  theme(axis.text.y = element_blank()) +
  theme(axis.ticks.y = element_blank()) + 
  theme(legend.key.size = unit(0.2, "cm")) -> 
  p1

result348 %>% 
  filter(actor == "Stochastic") %>% 
  filter(run <= 12) %>% 
  ggplot(aes(x=global_step, y=action, color=actor)) +
  lims(x=c(0, 320)) +
  geom_line(size=0.3, alpha=1) +
  labs(x="", y="", title="Stochastic") +
  facet_wrap(.~run, ncol=1) +
  theme_pubr(base_size = 8, legend = "none") +
  theme(strip.background = element_blank()) +
  scale_color_manual("Search", values=c("dodgerblue4")) +
  theme(panel.spacing = unit(0.1, "lines")) +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") +
  theme(plot.title = element_text(size = 6)) +
  theme(legend.box.background = element_rect(colour = "black", size=1)) +
  theme(strip.text.y = element_text(angle = 0)) +
  theme(strip.text.x = element_blank()) +
  # theme(axis.text.x = element_blank()) +
  theme(axis.text.y = element_blank()) +
  theme(axis.ticks.y = element_blank()) + 
  theme(legend.key.size = unit(0.2, "cm")) -> 
  p2

# ---
result348 %>% 
  filter(run == 42) %>% 
  filter(global_step > 5) %>%
  filter(actor != "Random") %>% 
  ggplot(aes(x=global_step, y=value_E, color=actor)) +
  geom_vline(aes(xintercept=min(num_trials)), 
             color="black", linetype="dashed", alpha=0.9, size=0.2) +
  geom_line(size=0.8, alpha=1) +
  lims(x=c(0, 320)) +
  scale_y_log10() +
  annotation_logticks(sides = "l") +
  facet_wrap(.~actor) +
  labs(x="", y="Value") + 
  scale_color_manual("", values=c("darkorchid4", "dodgerblue4")) +
  theme_pubr(base_size = 8, legend = "none") +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.background = element_blank()) +
  theme(strip.text.x = element_blank()) -> p3

result348 %>% 
  filter(run == 42) %>% 
  filter(global_step > 5) %>%
  filter(actor != "Random") %>% 
  ggplot(aes(x=global_step, y=regret, color=actor)) +
  geom_line(size=0.8, alpha=1) +
  lims(x=c(0, 320)) +
  scale_y_log10() +
  annotation_logticks(sides = "l") +
  facet_wrap(.~actor) +
  labs(x="Time", y="Regret") + 
  scale_color_manual("", values=c("darkorchid4", "dodgerblue4")) +
  theme_pubr(base_size = 8, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.text.x = element_blank()) -> p4


sub1 <- (p1 + p2) / p3 / p4 + 
  plot_layout(heights = c(0.7, 0.15, 0.15)) 
```

## Sub 2 - summary value (jitter)
```{r, fig.height=2, fig.width=0.8}
# average value
summary348 %>% 
  ggplot(aes(x=actor, y=total_E, color=actor)) +
  geom_jitter(size=0.3, alpha=0.9, width=0.2) +
  stat_summary(fun=median, color="black", alpha=0.9, size=2, shape="-") +
  scale_colour_manual("", 
                      values=c("darkorchid4", "dodgerblue4", "darkgray")) +
  labs(x="", y="Total value") +
  theme_pubr(base_size = 8, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") + 
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(1, "lines")) +
  theme(axis.text.x = element_blank()) -> 
  p1

# steps
summary348 %>% 
  ggplot(aes(x=actor, y=num_steps, color=actor)) +
  geom_jitter(size=0.3, alpha=0.9, width=0.2) +
  stat_summary(fun=median, color="black", alpha=0.9, size=2, shape="-") +
  scale_colour_manual("", 
                      values=c("darkorchid4", "dodgerblue4", "darkgray")) +
  labs(x="", y="Steps") +
  theme_pubr(base_size = 8, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") + 
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(1, "lines")) +
  theme(axis.text.x = element_blank()) -> 
  p2

# Total regret
summary348 %>% 
  ggplot(aes(x=actor, y=total_regret, color=actor)) +
  geom_jitter(size=0.3, alpha=0.9, width=0.2) +
  stat_summary(fun=median, color="black", alpha=0.9, size=2, shape="-") +
  scale_colour_manual("", 
                      values=c("darkorchid4", "dodgerblue4", "darkgray")) +
  labs(x="", y="Total regret") +
  scale_y_log10() +
  annotation_logticks(sides = "l") +
  theme_pubr(base_size = 8, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") + 
  theme(strip.background = element_blank()) +
  theme(axis.text.x = element_text(angle = 90)) +
  theme(panel.spacing = unit(1, "lines")) ->
  p3

# ---
sub2 <- p1 / p2 / p3 
```

## Build figure
```{r, fig.height=2.6, fig.width=2}
fig <- (sub1 | sub2 + plot_spacer()) + 
  plot_layout(widths = c(0.75, 0.25)) +
    plot_annotation(
      title="Deterministic versus stochastic curiosity in a random world", 
                  theme = theme_pubr(base_size = 8, legend = "none"))

print(fig)

# -- Save a to pdf --=
name <- "img/determinisitic_curiosity"
ggsave(paste(name, ".pdf", sep=""), plot=fig, height = 2.6*2, width = 2*2)
```
# Figure 2 - Dual value learning
- Explore/exploit as indepdendent objectives

## Load data
```{r message=FALSE, cache=TRUE}
exp_name <- "exp393"
param_codes <- 0:9
run_codes <- 1:10
file_names <- c("score_E", 
                "score_R", 
                "action", 
                "p_bests", 
                "regret", 
                "value_E", 
                "value_R", 
                "ties", 
                "policy",
                "total_E", 
                "total_R",
                "total_regret")

result393 <- load.result(exp_name, param_codes, run_codes, file_names)
result393 %>% 
  group_by(param, run) %>% 
  summarise(
    total_E=last(total_E),
    total_R=last(total_R),
    total_regret=last(total_regret),
    value_E=last(value_E),
    value_R=last(value_R),
    p_bests=last(p_bests)
  ) %>% 
  ungroup() ->
summary393
```

## Build figure
```{r, fig.height=2.25, fig.width=1.2}
result393 %>% 
  filter(run == 1, param == 1) %>% 
  # filter(global_step > 10) %>% 
  ggplot(aes(x=global_step, y=factor(policy), color=factor(policy))) +
  geom_point(size=0.8, alpha=0.5) +
  labs(x="", y="Policy") +
  scale_y_discrete(
    breaks=c(0, 1), 
    labels=c("Explore", "Exploit")) +
  lims(x=c(0, 200)) +
  scale_color_manual("", values=c("darkorchid4", "black")) +
  theme_pubr(base_size = 8, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(1, "lines")) -> p0

result393 %>% 
  filter(run == 1, param == 1) %>% 
  filter(global_step > 10) %>% 
  ggplot(aes(x=global_step, y=value_E)) +
  geom_line(size=0.6, alpha=1, color="darkorchid4") +
  lims(x=c(0, 200)) +
  scale_y_log10() +
  annotation_logticks(sides = "l") +
  labs(x="", y="Information value") + 
  theme_pubr(base_size = 8, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(1, "lines")) -> p1

result393 %>% 
  filter(run == 1, param == 1) %>% 
  filter(global_step > 10) %>% 
  ggplot(aes(x=global_step, y=value_R)) +
  geom_line(size=0.6, alpha=0.9, color="black") +
  lims(x=c(0, 200)) +
  scale_y_log10() +
  annotation_logticks(sides = "l") +
  labs(x="", y="Reward value") + 
  theme_pubr(base_size = 8, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(1, "lines")) -> p2

result393 %>% 
  filter(run == 1, param == 1) %>% 
  filter(global_step > 10) %>% 
  ggplot(aes(x=global_step, y=regret)) +
  geom_line(size=0.6, alpha=0.9, color="black") +
  lims(x=c(0, 200), y=c(0, 1)) +
  labs(x="Time", y="Regret") + 
  theme_pubr(base_size = 8, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(1, "lines")) -> p3

p0 / p1 / p2 / p3 + 
  plot_annotation(
      title="Explore/exploit with independent\ndeterministic policies", 
      theme = theme_pubr(base_size = 8, legend = "none"))

rm(p0, p1, p2, p3)
```
# Figure 4 - Indep explore/exploit: det versus sto
## Load data
```{r, message=FALSE}
# -------------------------------------------------------------
load.result <- function(exp_name, param_codes, run_codes, file_names){
  num_files <- length(file_names)
  result <- NULL
  for (param in param_codes){
    for (run in run_codes) {
      runtmp <- read_csv(paste(data_path, 
                               exp_name, 
                               paste("param", param, sep=""), 
                               paste("run", run, sep=""), 
                               paste(file_names[1], "csv", sep="."), sep="/"))    
      for (name in file_names[2:num_files]){
        tmp <- read_csv(paste(data_path, 
                              exp_name, 
                              paste("param", param, sep=""), 
                              paste("run", run, sep=""), 
                              paste(name, "csv", sep="."), sep="/"))  
        runtmp[[name]] <- tmp[[name]]
      }
      runtmp$run <- run
      runtmp$param <- param
      result <- bind_rows(result, runtmp)  
    }
  }
  result
}

# --------------------------------------------------------------------
exp_name <- "exp456"
param_codes <- 0:9
run_codes <- 1:10
file_names <- c("score_E", 
                "score_R", 
                "action", 
                "p_bests", 
                "regret", 
                "value_E", 
                "value_R", 
                "policy",
                "total_E", 
                "total_R",
                "total_regret")

result456 <- load.result(exp_name, param_codes, run_codes, file_names)
result456 %>% 
  group_by(param, run) %>% 
  summarise(
    total_E=last(total_E),
    total_R=last(total_R),
    total_regret=last(total_regret),
    value_E=last(value_E),
    value_R=last(value_R),
    p_bests=last(p_bests)
  ) %>% 
  ungroup() ->
summary456

# --------------------------------------------------------------------
exp_name <- "exp457"
param_codes <- 0:9
run_codes <- 1:10
file_names <- c("score_E", 
                "score_R", 
                "action", 
                "p_bests", 
                "regret", 
                "value_E", 
                "value_R", 
                "policy",
                "total_E", 
                "total_R",
                "total_regret")

result457 <- load.result(exp_name, param_codes, run_codes, file_names)
result457 %>% 
  group_by(param, run) %>% 
  summarise(
    total_E=last(total_E),
    total_R=last(total_R),
    total_regret=last(total_regret),
    value_E=last(value_E),
    value_R=last(value_R),
    p_bests=last(p_bests)
  ) %>% 
  ungroup() ->
summary457

# --------------------------------------------------------------------
exp_name <- "exp402"
param_codes <- c(0)
run_codes <- 1:100
file_names <- c("score_R", 
                "action", 
                "p_bests", 
                "regret", 
                "total_R",
                "value_R",
                "total_regret")

result402 <- load.result(exp_name, param_codes, run_codes, file_names)
result402 <- filter(result402, global_step <= 80) 
result402 %>% 
  group_by(param, run) %>% 
  summarise(
    total_R=last(total_R),
    value_R=last(value_R),
    total_regret=last(total_regret),
    p_bests=last(p_bests)
  ) %>% 
  ungroup() ->
summary402

# ---------------------------------------------------------------------
result456 %>% 
  dplyr::select(
    global_step, param, run, action, total_R, score_R, value_R,
    total_regret, p_bests) -> tmp1
result457 %>% 
  dplyr::select(
    global_step, param, run, action, total_R, score_R, value_R,
    total_regret, p_bests) -> tmp2
result402 %>% 
  dplyr::select(
    global_step, param, run, action, total_R, score_R, value_R,
    total_regret, p_bests) -> tmp3

tmp1$agent <- "Stochastic"
tmp2$agent <- "Deterministic"
tmp3$agent <- "Random"

result456_457 <- tmp1
result456_457 <- bind_rows(result456_457, tmp2)
result456_457 <- bind_rows(result456_457, tmp3)


# -----------------------------------------------------------------------
summary456 %>% 
  dplyr::select(param, run, total_R, value_R, total_regret, p_bests) -> tmp1
summary457 %>% 
  dplyr::select(param, run, total_R, value_R, total_regret, p_bests) -> tmp2
summary402 %>% 
  dplyr::select(param, run, total_R, value_R, total_regret, p_bests) -> tmp3

tmp1$agent <- "Stochastic"
tmp2$agent <- "Deterministic"
tmp3$agent <- "Random"

summary456_457 <- tmp1
summary456_457 <- bind_rows(summary456_457, tmp2)
summary456_457 <- bind_rows(summary456_457, tmp3)

summary456_457$agent <- factor(summary456_457$agent,
                               levels=c(
                                 "Deterministic", "Stochastic", "Random"))
```

## Sub 1a - action example
```{r, fig.width=1.6, fig.height=2}
result456_457 %>% 
  filter(agent == "Deterministic") %>% 
  # filter(global_step < 40) %>%
  filter(run <= 10, param == 1) %>%
  ggplot(aes(x=global_step, y=action, color=actor)) +
  geom_line(size=0.6, alpha=1) +
  labs(x="", y="Choice", title="Deterministic") +
  facet_grid(run~param) +
  theme_pubr(base_size = 8, legend = "none") +
  theme(strip.background = element_blank()) +
  scale_x_continuous(limits=c(-6, 86), breaks=c(0, 40, 80)) +
  scale_color_manual("Search", values=c("darkorchid4")) +
  theme(panel.spacing = unit(0.1, "lines")) +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") +
  theme(legend.box.background = element_rect(colour = "black", size=1)) +
  theme(plot.title = element_text(size = 6)) +
  theme(strip.text = element_blank()) +
  # theme(axis.text.x = element_blank()) +
  theme(axis.text.y = element_blank()) +
  theme(axis.ticks.y = element_blank()) + 
  theme(legend.key.size = unit(0.2, "cm")) -> 
  p1

result456_457 %>% 
  filter(agent == "Stochastic") %>% 
  filter(run <= 10, param == 1) %>%
  ggplot(aes(x=global_step, y=action, color=actor)) +
  geom_line(size=0.6, alpha=1) +
  labs(x="Time", y="", title="Stochastic") +
  facet_grid(run~param) +
  theme_pubr(base_size = 8, legend = "none") +
  theme(strip.background = element_blank()) +
  scale_color_manual("Search", values=c("dodgerblue4")) +
  scale_x_continuous(limits=c(-6, 86), breaks=c(0, 40, 80)) +
  theme(panel.spacing = unit(0.1, "lines")) +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") +
  theme(plot.title = element_text(size = 6)) +
  theme(legend.box.background = element_rect(colour = "black", size=1)) +
  theme(strip.text = element_blank()) +
  theme(axis.title.x = element_text(hjust = -.25)) +
  theme(axis.text.y = element_blank()) +
  theme(axis.ticks.y = element_blank()) + 
  theme(legend.key.size = unit(0.2, "cm")) -> 
  p2
```

## Sub 1b - reward value (timecourse)
```{r, fig.width=1.6, fig.height=0.6}
result456_457 %>% 
  filter(run <= 10, param == 1) %>%
  filter(agent != "Random") %>%
  ggplot(aes(x=global_step, y=value_R,
             color=agent, group=agent)) +
  geom_point(size=0.8, alpha=0.9, shape=".") +
  # approx median smooth
  geom_quantile(size=1, quantiles = 0.5, method = "rqss", color="black") + 
  labs(x="Time", y="Reward value") +
  facet_wrap(agent~., ncol=2) +
  scale_x_continuous(limits=c(-6, 86), breaks=c(0, 40, 80)) +
  scale_y_continuous(breaks=c(0, 0.5, 1), limits=c(-.1, 1.1)) +
  
  scale_colour_manual("Policy", values=c("darkorchid4", "dodgerblue4")) +
  theme_pubr(base_size = 8, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") +
  theme(legend.box.background = element_rect(colour = "black", size=1)) +
  theme(plot.title = element_text(size = 6)) +
  theme(strip.text = element_blank()) +
  # theme(axis.text.x = element_blank()) +
  # theme(axis.text.y = element_blank()) +
  # theme(axis.ticks = element_blank()) + 
  theme(legend.key.size = unit(0.2, "cm")) ->
  p3


sub1 <- (p1 + p2) / p3 + plot_layout(heights = c(0.85, 0.15))
```

## Sub 2 - summary value (jitter)
```{r, fig.height=0.9, fig.width=0.6}
# average value
summary456_457 %>% 
  ggplot(aes(x=agent, y=total_R/num_episodes, color=agent)) +
  geom_jitter(size=0.3, alpha=0.9, width=0.2) +
  stat_summary(fun=median, color="black", alpha=0.9, size=2, shape="-") +
  scale_colour_manual("", 
                      values=c("darkorchid4", "dodgerblue4", "darkgray")) +
  scale_y_continuous(breaks=c(0, 0.5, 1), limits=c(-.1, 1.1)) +
  labs(x="", y="Total reward") +
  theme_pubr(base_size = 8, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") + 
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(1, "lines")) +
  theme(axis.text.x = element_blank()) -> 
  p1

# Total regret
summary456_457 %>% 
  ggplot(aes(x=agent, y=total_regret/num_episodes, color=agent)) +
  geom_jitter(size=0.3, alpha=0.9, width=0.2) +
  stat_summary(fun=median, color="black", alpha=0.9, size=2, shape="-") +
  scale_colour_manual("", 
                      values=c("darkorchid4", "dodgerblue4", "darkgray")) +
  labs(x="", y="Total regret") +
  scale_y_log10() +
  annotation_logticks(sides = "l") +
  theme_pubr(base_size = 8, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") + 
  theme(strip.background = element_blank()) +
  theme(axis.text.x = element_text(angle = 90)) +
  theme(panel.spacing = unit(1, "lines")) ->
  p2

# ---
sub2 <- p1 / p2 
print(sub3)
```
## Build figure
```{r, fig.height=2.2, fig.width=1.7}
fig <- (sub1 | (sub2  + plot_spacer())) + 
  plot_layout(widths = c(0.8, 0.2)) +
    plot_annotation(
      title="Reward collection with independent policies:",
      subtitle = "deterministic versus stochastic",
                  theme = theme_pubr(base_size = 8, legend = "none"))

print(fig)

# -- Save a to pdf --=
# name <- "img/independent_sto_v_det"
# ggsave(paste(name, ".pdf", sep=""), plot=fig, height = 2.6*2, width = 2*2)
```


# Figure 5 - Independent versus joint value (aka intrinsic reward)
## Load data for BanditOneHigh4 experiments
- *NOTE*: result393_4 uses BanditOneHigh10, change to BanditOneHigh4 when that data is available. 
- *NOTE*: need random data (ep=1)

## Load data
```{r, message=FALSE}
# -------------------------------------------------------------
load.result <- function(exp_name, param_codes, run_codes, file_names){
  num_files <- length(file_names)
  result <- NULL
  for (param in param_codes){
    for (run in run_codes) {
      runtmp <- read_csv(paste(data_path, 
                               exp_name, 
                               paste("param", param, sep=""), 
                               paste("run", run, sep=""), 
                               paste(file_names[1], "csv", sep="."), sep="/"))    
      for (name in file_names[2:num_files]){
        tmp <- read_csv(paste(data_path, 
                              exp_name, 
                              paste("param", param, sep=""), 
                              paste("run", run, sep=""), 
                              paste(name, "csv", sep="."), sep="/"))  
        runtmp[[name]] <- tmp[[name]]
      }
      runtmp$run <- run
      runtmp$param <- param
      result <- bind_rows(result, runtmp)  
    }
  }
  result
}

# -------------------------------------------------------------
exp_name <- "exp393"
param_codes <- 0:9
run_codes <- 1:10
file_names <- c("score_E", 
                "score_R", 
                "action", 
                "p_bests", 
                "regret", 
                "value_E", 
                "value_R", 
                "ties", 
                "policy",
                "total_E", 
                "total_R",
                "total_regret")

result393 <- load.result(exp_name, param_codes, run_codes, file_names)
result393 %>% 
  group_by(param, run) %>% 
  summarise(
    total_E=max(total_E),
    total_R=max(total_R),
    total_regret=max(total_regret),
    value_E=median(value_E),
    value_R=median(value_R),
    p_bests=max(p_bests),
    regret=median(regret[regret > 0])
  ) %>% 
  ungroup() ->
summary393

# -------------------------------------------------------------
exp_name <- "exp396"
param_codes <- 0:9
run_codes <- 1:10
file_names <- c("score_R", 
                "score_E", 
                "action", 
                "p_bests", 
                "regret", 
                "value_ER",
                "total_R",
                "total_E",
                "total_regret")

result396 <- load.result(exp_name, param_codes, run_codes, file_names)
result396 %>% 
  group_by(param, run) %>% 
  summarise(
    total_R=max(total_R),
    total_E=max(total_E),
    total_regret=max(total_regret),
    value_ER=median(value_ER),
    p_bests=max(p_bests),
    regret=median(regret[regret > 0])
  ) %>% 
  ungroup() ->
summary396

# -------------------------------------------------------------
exp_name <- "exp397"
param_codes <- c(0)
run_codes <- 1:100
file_names <- c("score_R", 
                "action", 
                "p_bests", 
                "regret", 
                "total_R",
                "total_regret")

result397 <- load.result(exp_name, param_codes, run_codes, file_names)
result397 %>% 
  group_by(param, run) %>% 
  summarise(
    total_R=max(total_R),
    total_regret=max(total_regret),
    p_bests=max(p_bests),
    regret=median(regret[regret > 0])
  ) %>% 
  ungroup() ->
summary397

# -------------------------------------------------------------
# Join all the data
result393 %>% 
  dplyr::select(
    global_step, param, run, action, total_R, 
    total_regret, p_bests) -> tmp1
result396 %>% 
  dplyr::select(
    global_step, param, run, action, total_R, 
    total_regret, p_bests) -> tmp2
result397 %>% 
  dplyr::select(
    global_step, param, run, action, total_R, 
    total_regret, p_bests) -> tmp3

tmp1$agent <- "Deterministic"
tmp2$agent <- "Stochastic"
tmp3$agent <- "Random"

result393_7 <- tmp1
result393_7 <- bind_rows(result393_7, tmp2)
rm(tmp1, tmp2, tmp3)

# -------------------------------------------------------------
summary393 %>% 
  dplyr::select(param, run, total_R, total_regret, p_bests) -> tmp1
summary396 %>% 
  dplyr::select(param, run, total_R, total_regret, p_bests) -> tmp2
summary397 %>% 
  dplyr::select(param, run, total_R, total_regret, p_bests) -> tmp3

tmp1$agent <- "Deterministic"
tmp2$agent <- "Stochastic"
tmp3$agent <- "Random"

summary393_7 <- tmp1
summary393_7 <- bind_rows(summary393_7, tmp2)
summary393_7 <- bind_rows(summary393_7, tmp3)

summary393_7$agent <- factor(summary393_7$agent, 
                           levels=c("Deterministic", "Stochastic", "Random"))

rm(tmp1, tmp2, tmp3)
```

## Sub 1 - examples
```{r, fig.height=1.5, fig.width=1}
result393_7 %>% 
filter(agent == "Deterministic") %>% 
  # filter(global_step < 40) %>%
  filter(run == 1, param <= 10) %>% 
  ggplot(aes(x=global_step, y=action)) +
  geom_line(size=0.5, alpha=1, color="darkorchid4") +
  scale_x_continuous(breaks=c(0, 100, 200)) +
  labs(x="Time", y="Choice", title="Deterministic") +
  facet_wrap(.~param, ncol=1) +
  theme_pubr(base_size = 8, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(0.1, "lines")) +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") +
  theme(legend.box.background = element_rect(colour = "black", size=1)) +
  theme(plot.title = element_text(size = 6)) +
  theme(strip.text.y = element_text(angle = 0)) +
  theme(strip.text.x = element_blank()) +
  theme(axis.text.y = element_blank()) +
  theme(axis.ticks = element_blank()) + 
  theme(legend.key.size = unit(0.2, "cm")) -> p1

result393_7 %>% 
filter(agent == "Stochastic") %>% 
  # filter(global_step < 40) %>%
  filter(run == 1, param <= 10) %>% 
  ggplot(aes(x=global_step, y=action)) +
  geom_line(size=0.5, alpha=1, color="dodgerblue4") +
  labs(x="Time", y="", title="Stochastic") +
  scale_x_continuous(breaks=c(0, 100, 200)) +
  facet_wrap(.~param, ncol=1) +
  theme_pubr(base_size = 8, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(0.1, "lines")) +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") +
  theme(legend.box.background = element_rect(colour = "black", size=1)) +
  theme(plot.title = element_text(size = 6)) +
  theme(strip.text.y = element_text(angle = 0)) +
  theme(strip.text.x = element_blank()) +
  # theme(axis.text.x = element_blank()) +
  theme(axis.text.y = element_blank()) +
  theme(axis.ticks = element_blank()) + 
  theme(legend.key.size = unit(0.2, "cm")) -> p2

c1 <- p1 + p2
```

## Sub 2 - dists
```{r, fig.height=1.5, fig.width=0.8}
num_episodes <- 200

# average value
summary393_7 %>% 
  ggplot(aes(x=agent, y=total_R/num_episodes, color=agent)) +
  geom_jitter(size=0.3, alpha=0.9, width=0.2) +
  stat_summary(fun=median, color="black", alpha=0.9, size=2, shape="-") +
  scale_colour_manual("", 
                      values=c("darkorchid4", "dodgerblue4", "darkgray")) +
  lims(y=c(0,1)) +
  labs(x="", y="Total reward") +
  theme_pubr(base_size = 8, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") + 
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(1, "lines")) +
  theme(axis.text.x = element_blank()) -> 
  p1

# Total regret
summary393_7 %>% 

  ggplot(aes(x=agent, y=total_regret/num_episodes, color=agent)) +
  geom_jitter(size=0.3, alpha=0.9, width=0.2) +
  stat_summary(fun=median, color="black", alpha=0.9, size=2, shape="-") +
  scale_colour_manual("", 
                      values=c("darkorchid4", "dodgerblue4", "darkgray")) +
  labs(x="", y="Total regret") +
  theme_pubr(base_size = 8, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") + 
  theme(strip.background = element_blank()) +
  theme(axis.text.x = element_text(angle = 90)) +
  theme(panel.spacing = unit(1, "lines")) ->
  p2

c2 <- p1 / p2
```

## Build figure
```{r, fig.height=1.7, fig.width=1.5}
fig <- (c1 | c2 + plot_spacer()) + 
  plot_layout(widths = c(0.75, 0.25)) +
    plot_annotation(
      title="Cusiosity and reward collection in a random world", 
      theme = theme_pubr(base_size = 8, legend = "none"))

print(fig)

# -- Save a to pdf ---
name <- "img/reward_collection"
ggsave(paste(name, ".pdf", sep=""), plot=fig, height = 2.2*2, width = 1.5*2)

# -
# rm(c1, c2)
```

# Bandit figures:
The data is:
- BanditOneHigh4: exp398_402 (use for example above)
- BanditOneHigh10: exp393_exp397
- DeceptiveBanditOneHigh10: exp449_453
- BanditHardAndSparse10: exp408_412
- BanditOneHigh121: exp403_407
To do:
1. Load results for each.
2. Add to bandit_summary
3. Filter results to keep a few examples (saving memory)
Figure: 
- Examples: for each? of what? total_R? regret? p_best?
- Summary: jitter w/ median
- Consistent color coding

# Figure - BanditOneHigh10
## Load data
### Custom loader
```{r}
load.result <- function(exp_name, param_codes, run_codes, file_names){
  num_files <- length(file_names)
  result <- NULL
  for (param in param_codes){
    for (run in run_codes) {
      runtmp <- read_csv(paste(data_path, 
                               exp_name, 
                               paste("param", param, sep=""), 
                               paste("run", run, sep=""), 
                               paste(file_names[1], "csv", sep="."), sep="/"))    
      for (name in file_names[2:num_files]){
        tmp <- read_csv(paste(data_path, 
                              exp_name, 
                              paste("param", param, sep=""), 
                              paste("run", run, sep=""), 
                              paste(name, "csv", sep="."), sep="/"))  
        runtmp[[name]] <- tmp[[name]]
      }
      runtmp$run <- run
      runtmp$param <- param
      result <- bind_rows(result, runtmp)  
    }
  }
  result
}
```

### Load
```{r, message=FALSE}
# --- Init files ---

# The exps are:
exp_names <- c("exp393", 
               "exp394", 
               "exp395", 
               "exp396", 
               "exp397")
agent_names <- c("Curiosity", 
                 "del-Random", 
                 "tau-Random", 
                 "Intrinsic", 
                 "Random")

# These are shared in all models, but Random.
param_codes <- 0:9
run_codes <- 1:10

# Load only data every model has:
file_names <- c("action", 
                "p_bests", 
                "regret", 
                "total_R",
                "total_regret")

# -- Load ---
bandit_results <- NULL

# 1. Load random first (diff file structure)
bandit_results <- load.result(exp_names[5], c(0), 1:100, file_names)
bandit_results$exp <- exp_names[5]
bandit_results$agent <- agent_names[5]

# 2. then load the rest
for(i in 1:length(exp_names[1:4])){
  result <- load.result(exp_names[i], param_codes, run_codes, file_names)
  result$exp <- exp_names[i]
  result$agent <- agent_names[i]
  bandit_results <- bind_rows(bandit_results, result)
  rm(result)
}

# 3. summarize 
bandit_results %>% 
  group_by(agent, param, run) %>% 
  summarise(
    total_R=last(total_R),
    total_regret=last(total_regret),
    p_bests=last(p_bests)
  ) %>% 
  ungroup() ->
bandit_summary

# Reorder names
ordered_names <- c("Curiosity",
                   "Intrinsic", 
                   "tau-Random", 
                   "del-Random", 
                   "Random")
ordered_colors <- c("darkorchid4", 
                    "dodgerblue4", 
                    "goldenrod4", 
                    "darkgoldenrod3", 
                    "darkgrey")
bandit_results$agent <- factor(bandit_results$agent, levels = ordered_names)
bandit_summary$agent <- factor(bandit_summary$agent, levels = ordered_names)

# 5. Cleanup
rm(file_names, agent_names, exp_names, param_codes, run_codes, i)
```

### Sub 1 - actions examples
```{r, fig.width=1.8, fig.height=1.6}
bandit_results %>% 
  filter(agent != "Random") %>% 
  filter(run <= 10, param == 0) %>% 
  ggplot(aes(x=global_step, y=action, color=agent)) +
  geom_line(size=0.6, alpha=1) +
  labs(x="Time", y="Choice") +
  facet_grid(run~agent) +
  scale_colour_manual("", values=ordered_colors) +
  theme_pubr(base_size = 8, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(0.24, "lines")) +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") +
  theme(legend.box.background = element_rect(colour = "black", size=1)) +
  theme(plot.title = element_text(size = 6)) +
  theme(strip.text.y = element_blank()) +
  theme(axis.text.x = element_blank()) +
  theme(axis.text.y = element_blank()) +
  theme(axis.ticks = element_blank()) + 
  theme(legend.key.size = unit(0.2, "cm")) -> sub1
```

### Sub 2 - value summary
```{r, fig.width=1.2, fig.height=1.6}
num_episodes <- 200

## Values
bandit_summary %>% 
  ggplot(aes(x=agent, y=total_R/num_episodes, color=agent)) +
  geom_jitter(size=0.01, alpha=0.5, width=0.3) +
  stat_summary(fun=median, alpha=1, color="black", size=2, shape="-") +
  scale_colour_manual("", values=ordered_colors) +
  labs(y="Total reward", x="") +
  lims(y=c(0, 1)) +
  theme_pubr(base_size = 8, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") + 
  theme(strip.background = element_blank()) +
  theme(axis.text.x = element_blank()) +
  theme(panel.spacing = unit(1, "lines")) -> p1

bandit_summary %>% 
  ggplot(aes(x=agent, y=total_regret/num_episodes, color=agent)) +
  geom_jitter(size=0.01, alpha=0.5, width=0.3) +
  stat_summary(fun=median, alpha=1, color="black", size=2, shape="-") +
  scale_colour_manual("", values=ordered_colors) +
  labs(y="Total regret", x="") +
  lims(y=c(0, 1)) +
  theme_pubr(base_size = 8, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") + 
  theme(strip.background = element_blank()) +
  theme(axis.text.x = element_text(angle = 90)) +
  theme(panel.spacing = unit(1, "lines")) -> p2

bandit_summary %>% 
  ggplot(aes(x=agent, y=p_bests, color=agent)) +
  geom_jitter(size=0.05, alpha=0.5, width=0.3) +
  stat_summary(fun=median, alpha=1, color="black", size=2, shape="-") +
  scale_colour_manual("", values=ordered_colors) +
  labs(y="Best choice", x="") +
  lims(y=c(0, 1)) +
  theme_pubr(base_size = 8, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") + 
  theme(strip.background = element_blank()) +
  theme(axis.text.x = element_text(angle = 90)) +
  theme(panel.spacing = unit(1, "lines")) -> p3

sub2 <- p1 / p2 
```

### Build
```{r, fig.width=2.6, fig.height=2.4}
sub1 + (sub2 + plot_spacer()) + 
  plot_layout(widths = c(0.8, 0.2)) + 
  plot_annotation(
      title="Task 1 - reward collection with a high payout", 
                  theme = theme_pubr(base_size = 8, legend = "none"))
```

# Figure - Fast Bandits

Efficiency when time is low....
- Replot jitter w/ global_step at 2x? 
```{r}

```
