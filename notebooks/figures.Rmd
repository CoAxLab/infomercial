---
title: "Figures"
output: html_notebook
---

# Load library
```{r, message=FALSE}
library(zoo)
library(ggplot2)
library(ggpubr)
library(patchwork)
library(tidyr)
library(dplyr)
library(gridExtra)
library(grid)
library(readr)
library(latex2exp)
# library(MASS) 
library(scales)
library(patchwork)
options(scipen=1000000)

# Load load_result and other helpful functions
source("utils.R")

# --- Main path to all data ---
data_path <- "~/Code/infomercial/data/"
```

# Fig. Curiosity in a random world
## Load data
```{r message=FALSE, cache=TRUE}
# ---
exp_name <- "exp348"
num_episodes
actor_names <- c("DeterministicActor", 
                 "SoftmaxActor")
better_names <- c("Deterministic", 
                  "Stochastic")

run_codes <- 1:100
file_names <- c("score_E", 
                "action", 
                "p_bests", 
                "regret", 
                "value_E", 
                "ties", 
                "state", 
                "total_E", 
                "total_regret")

# -------------------------------------------------------------------
# This data has a slightly different structure compared to the rest in 
# this notebook so we Need a custom load loop.
result348 <- NULL
for (i in 1:length(actor_names)){
  actor <- actor_names[i]
  better <- better_names[i]
  for (run in run_codes) {
    runtmp <- read_csv(paste(data_path, 
                             exp_name, 
                             actor,
                             paste("run", run, sep=""), 
                             paste(file_names[1], "csv", sep="."), sep="/"))    
    for (name in file_names[2:9]){
      tmp <- read_csv(paste(data_path, 
                            exp_name, 
                            actor,
                            paste("run", run, sep=""), 
                            paste(name, "csv", sep="."), sep="/"))  
      runtmp[[name]] <- tmp[[name]]
    }
    runtmp$run <- run
    runtmp$actor <- better
    runtmp$num_episodes <- nrow(tmp)
    result348 <- bind_rows(result348, runtmp)  
  }
}

# -----------------------------------------------------------------------
# Don't need wall time
result348[["t"]] <- NULL

# Remove E_bias
num_arms <- 4
E_bias <- log(num_arms)
 
result348$total_E <- result348$total_E - (E_bias * num_arms)
result348$total_E[result348$total_E < 0] <- 0
# result348$score_E <- result348$score_E - E_bias
# result348$score_E[result348$score_E < 0] <- 0
# result348$value_E <- result348$value_E - E_bias
# result348$value_E[result348$value_E < 0] <- 0

# -----------------------------------------------------------------------
# Summarize the results 
result348 %>% 
  group_by(actor, run) %>% 
  summarise(
    total_E=last(total_E)/last(num_episodes),
    total_regret=last(total_regret)/last(num_episodes),
    total_steps=last(num_episodes)
  ) %>% 
  ungroup() ->
final348
final348$actor <- factor(
  final348$actor, levels=c("Stochastic", "Deterministic"))

final348 %>% 
  group_by(actor) %>% 
  summarise(
            median_E = median(total_E), 
            var_E = mad(total_E),
            median_steps = median(total_steps), 
            var_steps = mad(total_steps),
            median_regret = median(total_regret),
            var_regret = mad(total_regret)) %>% 
    ungroup() -> summary348

# -----------------------------------------------------------------------
# Clenup
rm(tmp, runtmp, run, name, better, i, actor_names, actor, better_names,
   E_bias, file_names, param_codes, run_codes, n, num_arm, num_arms, name)
```

## Build
```{r, fig.height=2.2, fig.width=2}
# -------------------------------------------------------------------
result348 %>% 
  filter(actor == "Deterministic") %>% 
  # filter(global_step < 40) %>%
  filter(run <= 12) %>% 
  ggplot(aes(x=global_step, y=action, color=actor)) +
  lims(x=c(0, 320)) +
  geom_point(size=0.2, alpha=0.9) +
  geom_line(size=0.1) +
  labs(x="", y="Choice", title="Deterministic") +
  facet_wrap(.~run, ncol=1) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  scale_color_manual("Search", values=c("mediumpurple4")) +
  theme(panel.spacing = unit(0.1, "lines")) +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") +
  theme(legend.box.background = element_rect(colour = "black", size=1)) +
  theme(plot.title = element_text(size = 6)) +
  theme(strip.text.y = element_text(angle = 0)) +
  theme(strip.text.x = element_blank()) +
  # theme(axis.text.x = element_blank()) +
  theme(axis.text.y = element_blank()) +
  # theme(axis.ticks.y = element_blank()) + 
  theme(legend.key.size = unit(0.2, "cm")) -> 
  c1a

result348 %>% 
  filter(actor == "Stochastic") %>% 
  filter(run <= 12) %>% 
  ggplot(aes(x=global_step, y=action, color=actor)) +
  lims(x=c(0, 320)) +
  geom_point(size=0.2, alpha=0.9) +
  geom_line(size=0.1) +
  labs(x="", y="", title="Stochastic") +
  facet_wrap(.~run, ncol=1) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  scale_color_manual("Search", values=c("mediumpurple3")) +
  theme(panel.spacing = unit(0.1, "lines")) +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") +
  theme(plot.title = element_text(size = 6)) +
  theme(legend.box.background = element_rect(colour = "black", size=1)) +
  theme(strip.text.y = element_text(angle = 0)) +
  theme(strip.text.x = element_blank()) +
  # theme(axis.text.x = element_blank()) +
  theme(axis.text.y = element_blank()) +
  # theme(axis.ticks.y = element_blank()) + 
  theme(legend.key.size = unit(0.2, "cm")) -> 
  c1b

result348 %>% 
  filter(run == 42) %>% 
  filter(global_step > 5) %>%
  ggplot(aes(x=global_step, y=value_E, color=actor)) +
  geom_vline(aes(xintercept=min(num_episodes)), 
             color="black", linetype="dashed", alpha=0.9, size=0.2) +
  geom_line(size=0.8, alpha=1) +
  lims(x=c(0, 320)) +
  scale_y_log10() +
  annotation_logticks(sides = "l") +
  facet_wrap(.~actor) +
  labs(x="", y="Info. value") + 
  scale_color_manual("", values=c("mediumpurple4", "mediumpurple3")) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.background = element_blank()) +
  theme(strip.text.x = element_blank()) -> 
  c1c

result348 %>% 
  filter(run == 42) %>% 
  filter(global_step > 5) %>%
  ggplot(aes(x=global_step, y=regret, color=actor)) +
  geom_line(size=0.8, alpha=1) +
  lims(x=c(0, 320)) +
  # scale_y_log10() +
  # annotation_logticks(sides = "l") +
  facet_wrap(.~actor) +
  labs(x="Time", y="Regret") + 
  scale_color_manual("", values=c("mediumpurple4", "mediumpurple3")) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.text.x = element_blank()) -> 
  c1d

sub1 <- (c1a + c1b) / c1c / c1d + 
  plot_layout(heights = c(0.8, 0.1, 0.1)) 
# print(sub1)

# ------------------------------------------------------------------
# average value
summary348 %>% 
  ggplot(aes(x=actor, y=median_E, color=actor)) +
  geom_point(size=1.5, alpha=1) +
  geom_jitter(data=final348,
             mapping=aes(x=actor, y=total_E, color=actor),
             size=0.1, alpha=0.3, width=0.2) +
  scale_colour_manual("", 
                      values=c("mediumpurple3", "mediumpurple4")) +
  labs(x="", y="Info. value") +
  scale_y_continuous(limits=c(0.0015, 0.0032), breaks = c(0.0015, 0.0015*2, 0.003)) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") + 
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(1, "lines")) +
  # theme(axis.text.x = element_blank()) +
  coord_flip() -> 
  c2a

summary348 %>% 
  ggplot(aes(x=actor, y=median_steps, color=actor)) +
  geom_point(size=1.5, alpha=1, position = position_dodge(width=1)) +
  geom_jitter(data=final348,
             mapping=aes(x=actor, y=total_steps, color=actor),
             size=0.1, alpha=0.3, width=0.2) +
  scale_colour_manual("", 
                      values=c("mediumpurple3", "mediumpurple4")) +
  labs(x="", y="Num. episodes") +
  scale_y_continuous(limits=c(80, 160), breaks = c(80, 120, 160)) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") + 
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(1, "lines")) +
  # theme(axis.text.x = element_blank()) +
  coord_flip() -> 
  c2b

# Total regret
summary348 %>% 
  ggplot(aes(x=actor, y=median_regret, color=actor)) +
  geom_point(size=1.5, alpha=1) +
  geom_jitter(data=final348,
             mapping=aes(x=actor, y=total_regret, color=actor),
             size=0.1, alpha=0.3, width=0.2) +
  scale_colour_manual("", 
                      values=c("mediumpurple3", "mediumpurple4")) +
  labs(x="", y="Regret") +
  scale_y_continuous(limits=c(0, 0.000045), breaks = c(0, 0.00004)) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") + 
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(1, "lines")) +
  # theme(axis.text.x = element_blank()) +
  coord_flip() -> 
  c2c

sub2 <- c2a / c2b / c2c

# -------------------------------------------------------------------------
fig <- (sub1 | sub2 + plot_spacer() + plot_spacer() + plot_spacer()) + 
  plot_layout(widths = c(0.7, 0.3)) +
    plot_annotation(
      title="Deterministic versus stochastic curiosity in a random world", 
                  theme = theme_pubr(base_size = 8, legend = "none"))
print(fig)

name <- "img/determinisitic_curiosity"
ggsave(paste(name, ".pdf", sep=""), plot=fig, height = 2.6*2, width = 2*2)

# -----------------------------------------------------------------------
## Cleanup
rm(sub1, sub2, c1a, c1b, c1c, c1d, c2a, c2b, c2c)
```

# Figure 2 - Dual value learning
- Explore/exploit as independent objectives
- Need math cartoon for the left hand side

## Load data
```{r message=FALSE, cache=TRUE}
exp_name <- "exp393"
param_codes <- 0:9
run_codes <- 1:10

# The overestimate due to E0
num_arms <- 4
E_bias <- log(num_arms) 

file_names <- c("score_E", 
                "score_R", 
                "action", 
                "p_bests", 
                "regret", 
                "value_E", 
                "value_R", 
                "ties", 
                "policy",
                "total_E", 
                "total_R",
                "total_regret")

result393 <- load_result(exp_name, param_codes, run_codes, file_names)

# Remove E_bias
result393$total_E <- result393$total_E - (E_bias * num_arms)
result393$total_E[result393$total_E < 0] <- 0
result393$score_E[result393$score_E >= E_bias] <- 0
result393$value_E[result393$value_E >= E_bias] <- 0

# Select data for example plot
r <- 4
p <- 9
n <- 100
eta <- 0.007
```

## Build
```{r, fig.height=2.9, fig.width=2.4}
# ---------------------------------------------------------------
# Timecourse
result393 %>% 
  filter(run == r, param == p) %>% 
  filter(global_step <= n) %>%
  ggplot(aes(x=global_step, y=factor(1-policy), color=factor(policy))) +
  geom_point(size=0.8, alpha=0.9) +
  labs(x="", y="Policy") +
  scale_y_discrete(
    breaks=c(0, 1), 
    labels=c("Exploit", "Explore")) +
  scale_x_continuous(limits=c(-1, n+1), breaks = c(0, n/2, n)) +
  scale_color_manual("", values=c("mediumpurple4", "black")) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(0.3, "lines")) -> c1a

result393 %>% 
  filter(run == r, param == p) %>% 
  filter(global_step <= n) %>%
  ggplot(aes(x=global_step, y=value_E)) +
  geom_line(size=0.6, color="mediumpurple4") +
  geom_hline(yintercept = eta, color="mediumpurple4", alpha=0.5, size=1) +
  scale_x_continuous(limits=c(-1, n+1), breaks = c(0, n/2, n)) +
  scale_y_log10() +
  annotation_logticks(side="l", size=.1) +
  labs(x="", y="Info. value", title="Explore") + 
  theme(strip.background = element_blank()) +
  theme_pubr(base_size = 6, legend = "none") -> c1b

result393 %>% 
  filter(run == r, param == p) %>% 
  filter(global_step <= n) %>%
  ggplot(aes(x=global_step, y=value_R)) +
  geom_line(size=0.6, color="black") +
  scale_x_continuous(limits=c(-1, n+1), breaks = c(0, n/2, n)) +
  scale_y_continuous(limits=c(-.1, 1.1), breaks=c(0, 0.5, 1)) +
  labs(x="Time", y="Reward value", title="Exploit") + 
  theme(strip.background = element_blank()) +
  theme_pubr(base_size = 6, legend = "none", ) -> c1c

result393 %>% 
  filter(run == r, param == p) %>% 
  filter(global_step <= n) %>%
  ggplot(aes(x=global_step, y=p_bests)) +
  geom_line(size=0.6, color="firebrick") +
  scale_x_continuous(limits=c(-1, n+1), breaks = c(0, n/2, n)) +
  scale_y_continuous(limits=c(-.1, 1.1), breaks=c(0, 0.5, 1)) +
  labs(x="Time", y="P(best choice)") + 
  theme(strip.background = element_blank()) +
  theme_pubr(base_size = 6, legend = "none", ) -> c1d

sub1 <- (c1a / c1b / c1c / c1d)


# --------------------------------------------------------------------
# Actions and values
result393 %>% 
  filter(run == r, param == p) %>% 
  filter(global_step <= n) %>%
  ggplot(aes(x=global_step, y=action, color=factor(policy))) +
  geom_point(size=0.6, alpha=0.9) +
  geom_line(size=0.1) +
  labs(x="Time", y="Choice") +
  facet_wrap(policy~., ncol=2) +
  scale_x_continuous(limits=c(-1, n+1), breaks = c(0, n/2, n)) +
  scale_y_continuous(breaks=c(0,9), limits=c(-1, 10)) +
  scale_color_manual("", values=c("mediumpurple4", "black")) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(strip.text = element_blank()) +
  theme(panel.spacing = unit(0.5, "lines")) -> c2a

result393 %>% 
  filter(run == r, param == p) %>% 
  filter(global_step <= n) %>%
  filter(value_E >= eta) %>% 
  ggplot(aes(x=global_step, y=value_E)) +
  geom_point(size=0.6, color="mediumpurple4") +
  geom_line(size=0.1, color="mediumpurple4") +
  geom_hline(yintercept = eta, color="mediumpurple4", alpha=0.5, size=1) +
  scale_x_continuous(limits=c(-1, n+1), breaks = c(0, n/2, n)) +
  scale_y_log10(limits=c(0.0001, 4)) +
  annotation_logticks(side="l", size=.1) +
  labs(x="", y="Information", title="Explore") + 
  facet_grid(action~.) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.text = element_blank()) +
  theme(strip.background = element_blank()) -> c2b

result393 %>% 
  filter(run == r, param == p) %>% 
  filter(global_step <= n) %>%
  ggplot(aes(x=global_step, y=score_R)) +
  geom_point(size=0.6, color="black") +
  geom_line(size=0.1, color="black") +
  scale_x_continuous(limits=c(-1, n+1), breaks = c(0, n/2, n)) +
  scale_y_continuous(limits=c(-.1, 1.1), breaks=c(0, 0.5, 1)) +
  labs(x="Time", y="Reward", title="Exploit") + 
  facet_grid(action~.) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.text = element_blank()) +
  theme(strip.background = element_blank()) -> c2c

sub2 <- (c2a / (c2b + c2c)) + plot_layout(heights = c(0.1, 0.9))

# -----------------------------------------------------------------------
## Build figure
(sub1 + plot_spacer() + plot_spacer() | sub2) +
  plot_annotation(
      title="Explore-exploit with independent deterministic policies", 
      theme = theme_pubr(base_size = 8, legend = "none"))

# -----------------------------------------------------------------------
## Cleanup
rm(sub1, sub2, c1a, c1b, c1c, c1d, c2a, c2b, c2c)
```

# Figure 3 - Extrinsic rewards, intrinsic rewards, and independent policies.
## Load data (task 1)
```{r, message=FALSE}
# -------------------------------------------------------------
task_name <- "BanditOneHigh4"
task_code <- 1
num_episodes <- 2000
num_sum <- c(4, 8, 16, 32, 96, 400, 2000)
# num_sum <- c(2000)

# Common neuro models
exp_names <- c("exp534", "exp502","exp525", "exp501", "exp539")
agent_names <- c("Curiosity", "Extrinsic", "Info/Extrin.", "Novelty", "Count (UCB)")

# All models
# exp_names <- c("exp534", "exp526", "exp527", "exp547", "exp502",
#                "exp525", "exp501", "exp504", "exp503", "exp539")
# agent_names <- c("Curiosity", "del-random", "tau-random", "Random", "Extrinsic",
#                  "Info", "Novelty", "Entropy", "Count (EB)", "Count (UCB)")

file_names <- c("score_R", 
                "action", 
                "p_bests", 
                "regret", 
                "total_R",
                "total_regret")

result_part1<- NULL
summary_part1 <- NULL
for(i in 1:length(exp_names)){
  exp_name <- exp_names[i]
  agent_name <- agent_names[i]
  if (agent_name == "Random"){
    param_codes <- c(0)
    run_codes <- 1:100
  } else{
    param_codes <- 0:9
    run_codes <- 1:10
  }
  tmp1 <- load_result(exp_name, param_codes, run_codes, file_names)
  tmp1 %>% 
    filter(global_step <= num_episodes) -> tmp1
  tmp1$exp <- exp_name
  tmp1$agent <- agent_name
  tmp1$task <- task_name
  tmp1$task_code <- task_code
  tmp1$num_episodes <- num_episodes
  result_part1 <- bind_rows(result_part1, tmp1)
  
  for (n in num_sum){
    tmp1 %>% 
      filter(global_step <= n) %>% 
      summarise_reward() -> tmp2  
    tmp2$exp <- exp_name
    tmp2$agent <- agent_name
    tmp2$task <- task_name
    tmp2$task_code <- task_code
    tmp2$num_episodes <- num_episodes
    tmp2$n <- n
    summary_part1 <- bind_rows(summary_part1, tmp2)
  }
}

rm(tmp1, tmp2, agent_name, agent_names, exp_name, exp_names, file_names, 
   i, param_codes, run_codes, task_name)
```

## Fig. 
### totals - task 1 totals
```{r, fig.width=2.1, fig.height=0.9}
num <- 2000
summary_part1 %>% 
  filter(n == num) %>% 
  ggplot(aes(x=agent, y=total_R/n)) +
  geom_jitter(width=0.1, alpha=0.6, shape=".") +
  stat_summary(fun=median, alpha=1, color="red", size=0.4, shape="|") +
  # geom_boxplot(size=0.4, outlier.size = .1) +
  scale_y_continuous(limits=c(-.1, 1.1), breaks = c(0, 0.5, 1)) +
  labs(x="", y="Total reward") +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  coord_flip() -> p1

summary_part1 %>% 
  filter(n == num) %>% 
  ggplot(aes(x=agent, y=total_regret/n)) +
  geom_jitter(width=0.1, alpha=0.6, shape=".") +
  stat_summary(fun=median, alpha=1, color="red", size=0.4, shape="|") +
  # geom_boxplot(size=0.4, outlier.size = .1) +
  # scale_y_continuous(limits=c(-.1, 1.1), breaks = c(0, 0.5, 1)) +
  labs(x="", y="Total regret") +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(axis.text.y = element_blank()) +
  coord_flip() -> p2

summary_part1 %>% 
  filter(n == num) %>% 
  ggplot(aes(x=agent, y=p_bests)) +
  geom_jitter(width=0.1, alpha=0.6, shape=".") +
  stat_summary(fun=median, alpha=1, color="red", size=0.4, shape="|") +
  # geom_boxplot(size=0.4, outlier.size = .1) +
  scale_y_continuous(limits=c(-.1, 1.1), breaks = c(0, 0.5, 1)) +
  labs(x="", y="P(best)") +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(axis.text.y = element_blank()) +
  coord_flip() -> p3

# -------------------------------------------------------------------
p1 + p2 + p3 + 
  plot_annotation(title = "Task 1", 
                  theme = theme_pubr(base_size = 8, legend = "none"))
```

## Fig. Task 1
### Load data
```{r, message=FALSE}
# -------------------------------------------------------------
task_name <- "BanditOneHigh4"
task_code <- 1
num_episodes <- 4*50

# The overestimate due to E0
num_arms <- 4
E_bias <- log(num_arms) * num_arms 

exp_names <- c(
  "exp457", 
  "exp526", 
  "exp527", 
  "exp547", 
  "exp502",
  "exp525", 
  "exp501", 
  "exp504", 
  "exp503", 
  "exp539")

agent_names <- c(
  "Curiosity",
  "del-random", 
  "tau-random", 
  "Random", 
  "Extrinsic", 
  "Info", 
  "Novelty", 
  "Entropy", 
  "Count (EB)", 
  "Count (UCB)")

class_names <- c(
  "Curiosity",
  "Random",
  "Random",
  "Random",
  "Extrinsic",
  "Intrinsic",
  "Intrinsic",
  "Intrinsic",
  "Intrinsic",
  "Intrinsic"
)

file_names <- c("action", 
                "p_bests", 
                "total_R",
                "total_E",
                "total_regret")

result_task1<- NULL
summary_task1 <- NULL
for(i in 1:length(exp_names)){
  exp_name <- exp_names[i]
  agent_name <- agent_names[i]
  class_name <- class_names[i]
  if (agent_name == "Random"){
    param_codes <- c(0)
    run_codes <- 1:100
  } else{
    param_codes <- 0:9
    run_codes <- 1:10
  }
  
  tmp <- load_result(exp_name, param_codes, run_codes, file_names, 
                     n_max=num_episodes+1)
  
  tmp %>% 
    filter(global_step <= num_episodes) -> tmp
  tmp$exp <- exp_name
  tmp$agent <- agent_name
  tmp$task <- task_name
  tmp$task_code <- task_code
  tmp$strategy <- class_name
  tmp$num_episodes <- num_episodes
  
  result_task1 <- bind_rows(result_task1, tmp)
}

# Remove E_bias
result_task1$total_E <- result_task1$total_E - E_bias
result_task1$total_E[result_task1$total_E < 0] <- 0

# Novelty, extrinsic have total_E but it is not used, so set 
# it to zero 
for(a_name in c("Extrinsic", "Novelty")) {
  m <- result_task1$agent == a_name
  result_task1[["total_E"]][m] <- 0
}

# Cleanup
rm(tmp, agent_name, agent_names, class_names, class_name, 
   exp_name, exp_names, file_names, i, param_codes, 
   run_codes, task_name, m)
```


### Actions
```{r, fig.width=3, fig.height=1.4}
p <- 10
r <- 3

num_arm <- max(result_task1$action) + 1

result_task1 %>% 
  filter(param <= p, run == r) %>% 
  mutate(
    color = ifelse(strategy == "Curiosity", "mediumpurple4", "black")) %>%
  ggplot(aes(x=global_step, y=action+1, color=color)) +
  geom_point(size=0.2, alpha=0.9) +
  geom_line(size=0.1) +
  scale_x_continuous(
    limits=c(0, num_episodes+(num_episodes*.1)), 
    breaks = c(0, num_episodes)) +
  scale_color_identity() +
  scale_y_continuous(limits=c(0, num_arm+1), breaks = 1:num_arm) +
  facet_grid(agent~param) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(.1, "lines")) +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") +
  theme(legend.box.background = element_rect(colour = "black", size=1)) +
  theme(plot.title = element_text(size = 6)) +
  theme(strip.text.y = element_text(angle = 0)) +
  theme(strip.text.x = element_blank()) +
  theme(axis.text.y = element_blank()) 
```

### Reward (time)
```{r, fig.width=3.2, fig.height=0.7}
p <- 2
r <- 10

result_task1 %>% 
  filter(global_step > 10) %>% 
  filter(param <= p, run <= r) %>% 
  ggplot(aes(x=global_step, y=total_R/global_step, 
             group=interaction(param,run))) +
  geom_line(size=0.1, alpha=1, shape=".") +
  labs(x="Time", y="Reward") +
  scale_x_continuous(limits=c(0, 200),
                     breaks = c(0, 200)) +
  # scale_y_continuous(limits=c(0, 0.022),
                     # breaks = c(0, 0.01, 0.02)) +
  facet_wrap(agent~., nrow=1) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.background = element_blank()) 
```

### Info value (time)
```{r, fig.width=3.2, fig.height=0.7}
p <- 2
r <- 10

result_task1 %>% 
  filter(global_step > 10) %>% 
  filter(param <= p, run <= r) %>% 
  ggplot(aes(x=global_step, y=total_E/global_step, 
             group=interaction(param,run))) +
  geom_line(size=0.1, alpha=1) +
  labs(x="Time", y="Info value") +
  scale_x_continuous(limits=c(0, num_episodes),
                     breaks = c(0, num_episodes)) +
  # scale_y_continuous(limits=c(0, 1),
                     # breaks = c(0, 0.5, 1)) +
  facet_wrap(agent~., nrow=1) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.background = element_blank()) 
```

### Value (time)
```{r, fig.width=3.2, fig.height=0.7}
p <- 2
r <- 10

result_task1 %>% 
  filter(global_step > 10) %>% 
  filter(param <= p, run <= r) %>% 
  group_by(agent, param, run) %>% 
  mutate(total_value = total_R + total_E) %>% 
  ggplot(aes(x=global_step, y=total_value/global_step, 
             group=interaction(param,run))) +
  geom_line(size=0.1, alpha=1, shape=".") +
  labs(x="Time", y="Value") +
  scale_x_continuous(limits=c(0, num_episodes),
                     breaks = c(0, num_episodes)) +
  # scale_y_continuous(limits=c(0, 0.022),
                     # breaks = c(0, 0.01, 0.02)) +
  facet_wrap(agent~., nrow=1) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.background = element_blank()) 
```

### Regret (time)
```{r, fig.width=3.2, fig.height=0.7}
p <- 2
r <- 10

result_task1 %>% 
  filter(global_step > 10) %>% 
  filter(param <= p, run <= r) %>% 
  ggplot(aes(x=global_step, y=total_regret/global_step, 
             group=interaction(param,run))) +
  geom_line(size=0.1, alpha=1, shape=".") +
  labs(x="Time", y="Regret") +
  scale_x_continuous(limits=c(0, num_episodes),
                     breaks = c(0, num_episodes)) +
  # scale_y_continuous(limits=c(0, 0.022),
  #                    breaks = c(0, 0.01, 0.02)) +
  facet_wrap(agent~., nrow=1) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.background = element_blank()) 
```


### Summary stats
```{r, fig.width=2.1, fig.height=0.9}
result_task1 %>% 
  filter(agent != "Random") %>%
  group_by(strategy, agent, param, run) %>% 
  summarise(total_R = last(total_R),
            total_E = sum(total_E),
            total_value = last(total_R) + last(total_E),
            total_regret = last(total_regret),
            p_bests = last(p_bests)) %>% 
  ungroup() -> tmp

tmp %>% 
  group_by(strategy, agent) %>% 
  summarise(median_R = median(total_R), 
            var_R = mad(total_R),
            median_E = mean(total_E), 
            var_E = mad(total_E),
            median_total_value = median(total_value), 
            var_total_value = mad(total_value),
            median_regret = median(total_regret),
            var_regret = mad(total_regret),
            median_p_bests=median(p_bests),
            var_p_bests=mad(p_bests)) %>% 
  ungroup() -> tmp

tmp %>% 
  mutate(
    color = ifelse(strategy == "Curiosity", "mediumpurple4", "black")) %>%
  ggplot(aes(x=agent, y=median_R/num_episodes, color=color)) +
  geom_point(size=1, alpha=1) +
  geom_linerange(aes(
    ymin=(median_R+var_R)/num_episodes, 
    ymax=(median_R-var_R)/num_episodes), 
    alpha=0.4) +
  geom_hline(aes(yintercept=max(median_R/num_episodes)), 
             color="black",
             size=0.1) +
  labs(x="", y="Reward") +
  lims(y=c(0.5, 0.9)) +
  scale_color_identity() +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  coord_flip() -> p1

tmp %>% 
  mutate(
    color = ifelse(strategy == "Curiosity", "mediumpurple4", "black")) %>%
  ggplot(aes(x=agent, y=median_E/num_episodes, color=color)) +
  geom_point(size=1, alpha=1) +
  geom_linerange(aes(
    ymin=((median_E+var_E)/num_episodes), 
    ymax=((median_E-var_E)/num_episodes)), 
    alpha=0.4) +
  geom_hline(aes(yintercept=max(median_E)/num_episodes), 
             color="black",
             size=0.1) +
  labs(x="", y="Info. value") +
  # lims(y=c(0.5, 1)) +
  scale_color_identity() +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(axis.text.y = element_blank()) +
  coord_flip() -> p2

tmp %>% 
  mutate(
    color = ifelse(strategy == "Curiosity", "mediumpurple4", "black")) %>%
  ggplot(aes(x=agent, y=median_regret/num_episodes, color=color)) +
  geom_point(size=1, alpha=1) +
  geom_linerange(aes(
    ymin=((median_regret+var_regret)/num_episodes), 
    ymax=((median_regret-var_regret)/num_episodes)), 
    alpha=0.4) +
  geom_hline(aes(yintercept=min(median_regret)/num_episodes),  
             color="black",
             size=0.1) +
  labs(x="", y="Regret") +
  scale_color_identity() +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(axis.text.y = element_blank()) +
  coord_flip() -> p3

# -------------------------------------------------------------------
(p1 + p2 + p3) + 
  plot_annotation(title = "Task 1 - Classic", 
                  theme = theme_pubr(base_size = 8, legend = "none"))
# print(sub1)
```

## Fig. Task 2 
### Load data 
```{r, message=FALSE}
# -------------------------------------------------------------
task_name <- "BanditHardAndSparse10"
task_code <- 2
num_episodes <- 50000

# The overestimate due to E0
num_arms <- 10
E_bias <- log(num_arms) * num_arms 

exp_names <- c("exp546",
               "exp409", 
               "exp410", 
               "exp412", 
               "exp514",
               "exp411", 
               "exp513", 
               "exp516", 
               "exp515", 
               "exp542")

agent_names <- c("Curiosity", 
                 "del-random", 
                 "tau-random", 
                 "Random",
                 "Extrinsic", 
                 "Info", 
                 "Novelty", 
                 "Entropy", 
                 "Count (EB)",
                 "Count (UCB)")

class_names <- c(
  "Curiosity",
  "Random",
  "Random",
  "Random",
  "Extrinsic",
  "Intrinsic",
  "Intrinsic",
  "Intrinsic",
  "Intrinsic",
  "Intrinsic"
)

file_names <- c("action", 
                "p_bests", 
                "total_R",
                "total_E",
                "total_regret")

result_task2 <- NULL
for(i in 1:length(exp_names)){
  exp_name <- exp_names[i]
  agent_name <- agent_names[i]
  class_name <- class_names[i]
  if (agent_name == "Random"){
    param_codes <- c(0)
    run_codes <- 1:100
  } else{
    param_codes <- 0:9
    run_codes <- 1:10
  }
  
  tmp <- load_result(
    exp_name, param_codes, run_codes, file_names, n_max=num_episodes+1)
  
  tmp %>% 
    filter(global_step <= num_episodes) -> tmp
  tmp$exp <- exp_name
  tmp$agent <- agent_name
  tmp$task <- task_name
  tmp$task_code <- task_code
  tmp$strategy <- class_name
  tmp$num_episodes <- num_episodes
  
  result_task2 <- bind_rows(result_task2, tmp)
}

# Remove E_bias
result_task2$total_E <- result_task2$total_E - E_bias
result_task2$total_E[result_task2$total_E < 0] <- 0

# Novelty, extrinsic have total_E but it is not used, so set 
# it to zero 
for(a_name in c("Extrinsic", "Novelty")) {
  m <- result_task2$agent == a_name
  result_task2[["total_E"]][m] <- 0
}

# Cleanup
rm(tmp, agent_name, agent_names, class_names, class_name, 
   exp_name, exp_names, file_names, i, param_codes, 
   run_codes, task_name, m)
```

### Actions
```{r, fig.width=3, fig.height=1.4}
p <- 10
r <- 3

num_arm <- max(result_task2$action) + 1

result_task2 %>% 
  mutate(
    color = ifelse(strategy == "Curiosity", "mediumpurple4", "black")) %>%
  filter(param <= p, run == r) %>% 
  ggplot(aes(x=global_step, y=action+1, color=color)) +
  geom_point(size=0.2, alpha=0.9) +
  geom_line(size=0.1) +
  scale_x_continuous(
    limits=c(0, num_episodes+(num_episodes*.1)), 
    breaks = c(0, num_episodes)) +
  scale_color_identity() +
  scale_y_continuous(limits=c(0, num_arm+1), breaks = 1:num_arm) +
  labs(x="Time", y="Action") +
  facet_grid(agent~param) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(.1, "lines")) +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") +
  theme(legend.box.background = element_rect(colour = "black", size=1)) +
  theme(plot.title = element_text(size = 6)) +
  theme(strip.text.y = element_text(angle = 0)) +
  theme(strip.text.x = element_blank()) +
  theme(axis.text.y = element_blank()) 
```

### Reward (time)
```{r, fig.width=3.2, fig.height=0.7}
p <- 2
r <- 10

result_task2 %>% 
  filter(global_step > 10) %>% 
  filter(param <= p, run <= r) %>% 
  ggplot(aes(x=global_step, y=total_R/global_step, 
             group=interaction(param,run))) +
  geom_line(size=0.1, alpha=1, shape=".") +
  labs(x="Time", y="Reward") +
  scale_x_continuous(limits=c(0, num_episodes),
                     breaks = c(0, num_episodes)) +
  scale_y_continuous(limits=c(0, 0.022),
                     breaks = c(0, 0.01, 0.02)) +
  facet_wrap(agent~., nrow=1) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.background = element_blank()) 
```

### Info value (time)
```{r, fig.width=3.2, fig.height=0.7}
p <- 2
r <- 10

result_task2 %>% 
  filter(global_step > 10) %>% 
  filter(param <= p, run <= r) %>% 
  ggplot(aes(x=global_step, y=total_E/global_step, 
             group=interaction(param,run))) +
  geom_line(size=0.1, alpha=1, shape=".") +
  labs(x="Time", y="Info value") +
  scale_x_continuous(limits=c(0, num_episodes),
                     breaks = c(0, num_episodes)) +
  # scale_y_continuous(limits=c(0, 1),
                     # breaks = c(0, 0.5, 1)) +
  facet_wrap(agent~., nrow=1) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.background = element_blank()) 
```

### Value (time)
```{r, fig.width=3.2, fig.height=0.7}
p <- 2
r <- 10

result_task2 %>% 
  filter(global_step > 10) %>% 
  filter(param <= p, run <= r) %>% 
  group_by(agent, param, run) %>% 
  mutate(total_value = total_R + total_E) %>% 
  ggplot(aes(x=global_step, y=total_value/global_step, 
             group=interaction(param,run))) +
  geom_line(size=0.1, alpha=1, shape=".") +
  labs(x="Time", y="Value") +
  scale_x_continuous(limits=c(0, num_episodes),
                     breaks = c(0, num_episodes)) +
  scale_y_continuous(limits=c(0, 0.022),
                     breaks = c(0, 0.01, 0.02)) +
  facet_wrap(agent~., nrow=1) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.background = element_blank()) 
```
### Regret (time)
```{r, fig.width=3.2, fig.height=0.7}
p <- 2
r <- 10

result_task2 %>% 
  filter(global_step > 10) %>% 
  filter(param <= p, run <= r) %>% 
  ggplot(aes(x=global_step, y=total_regret/global_step, 
             group=interaction(param,run))) +
  geom_line(size=0.1, alpha=1, shape=".") +
  labs(x="Time", y="Regret") +
  scale_x_continuous(limits=c(0, num_episodes),
                     breaks = c(0, num_episodes)) +
  scale_y_continuous(limits=c(0, 0.022),
                     breaks = c(0, 0.01, 0.02)) +
  facet_wrap(agent~., nrow=1) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.background = element_blank()) 
```

### Summary stats
```{r, fig.width=2.1, fig.height=0.9}
result_task2 %>% 
  filter(agent != "Random") %>% 
  group_by(strategy, agent, param, run) %>% 
  summarise(total_R = last(total_R),
            total_E = sum(total_E),
            total_value = last(total_R) + last(total_E),
            total_regret = last(total_regret),
            p_bests = last(p_bests)) %>%
  ungroup() %>% 
  group_by(strategy, agent) %>% 
  summarise(median_R = median(total_R), 
            var_R = mad(total_R),
            median_E = median(total_E), 
            var_E = mad(total_E),
            median_total_value = median(total_value), 
            var_total_value = mad(total_value),
            median_regret = median(total_regret),
            var_regret = mad(total_regret),
            median_p_bests=median(p_bests),
            var_p_bests=mad(p_bests)) %>% 
  ungroup() -> tmp

tmp %>% 
  mutate(
    color = ifelse(strategy == "Curiosity", "mediumpurple4", "black")) %>%
  ggplot(aes(x=agent, y=median_R/num_episodes, color=color)) +
  geom_point(size=1, alpha=1) +
  geom_linerange(aes(
    ymin=(median_R+var_R)/num_episodes, 
    ymax=(median_R-var_R)/num_episodes), 
    alpha=0.4) +
  geom_hline(aes(yintercept=max(median_R)/num_episodes), 
             color="black",
             size=0.1) +
  labs(x="", y="Reward") +
  scale_y_continuous(limits=c(0.008, 0.022), breaks=c(0.01, 0.02)) +
  scale_color_identity() +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  coord_flip() -> p1

tmp %>% 
  mutate(
    color = ifelse(strategy == "Curiosity", "mediumpurple4", "black")) %>%
  ggplot(aes(x=agent, y=median_E/num_episodes, color=color)) +
  geom_point(size=1, alpha=1) +
  geom_linerange(aes(
    ymin=(median_E+var_E)/num_episodes, 
    ymax=(median_E-var_E)/num_episodes), 
    alpha=0.4) +
  geom_hline(aes(yintercept=max(median_E)/num_episodes), 
             color="black",
             size=0.1) +
  labs(x="", y="Info. value") +
  # scale_y_continuous(limits=c(0.00, 0.002), breaks=c(0.0, 0.002)) +
  scale_color_identity() +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(axis.text.y = element_blank()) +
  coord_flip() -> p2

tmp %>% 
  mutate(
    color = ifelse(strategy == "Curiosity", "mediumpurple4", "black")) %>%
  ggplot(aes(x=agent, y=median_regret/num_episodes, color=color)) +
  geom_point(size=1, alpha=1) +
  geom_linerange(aes(
    ymin=(median_regret+var_regret)/num_episodes, 
    ymax=(median_regret-var_regret)/num_episodes), 
    alpha=0.4) +
  geom_hline(aes(yintercept=min(median_regret)/num_episodes), 
             color="black",
             size=0.1) +
  labs(x="", y="Regret") +
  scale_color_identity() +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(axis.text.y = element_blank()) +
  coord_flip() -> p3

# -------------------------------------------------------------------
(p1 + p2 + p3) + 
  plot_annotation(title = "Task 2 - Sparse", 
                  theme = theme_pubr(base_size = 8, legend = "none"))
# print(sub2)
```

## Fig. Task 3
### Load data
```{r, message=FALSE}
# -------------------------------------------------------------
task_name <- "BanditOneHigh121"
task_code <- 3
num_episodes <- 121 * 50

# The overestimate due to E0
num_arms <- 121
E_bias <- log(num_arms) * num_arms 

exp_names <- c("exp403", 
               "exp404", 
               "exp405", 
               "exp407", 
               "exp510",
               "exp406",
               "exp509", 
               "exp512", 
               "exp511", 
               "exp541")

agent_names <- c("Curiosity", 
                 "del-random", 
                 "tau-random", 
                 "Random",
                 "Extrinsic", 
                 "Info", 
                 "Novelty", 
                 "Entropy", 
                 "Count (EB)",
                 "Count (UCB)")

class_names <- c(
  "Curiosity",
  "Random",
  "Random",
  "Random",
  "Extrinsic",
  "Intrinsic",
  "Intrinsic",
  "Intrinsic",
  "Intrinsic",
  "Intrinsic"
)

file_names <- c("action", 
                "p_bests", 
                "total_R",
                "total_E",
                "total_regret")

result_task3 <- NULL
for(i in 1:length(exp_names)){
  exp_name <- exp_names[i]
  agent_name <- agent_names[i]
  class_name <- class_names[i]
  if (agent_name == "Random"){
    param_codes <- c(0)
    run_codes <- 1:100
  } else{
    param_codes <- 0:9
    run_codes <- 1:10
  }
  
  tmp <- load_result(
    exp_name, param_codes, run_codes, file_names, n_max=num_episodes+1)
  
  tmp %>% 
    filter(global_step <= num_episodes) -> tmp
  tmp$exp <- exp_name
  tmp$agent <- agent_name
  tmp$task <- task_name
  tmp$task_code <- task_code
  tmp$strategy <- class_name
  tmp$num_episodes <- num_episodes
  
  result_task3 <- bind_rows(result_task3, tmp)
}

# Remove E_bias
result_task3$total_E <- result_task3$total_E - E_bias
result_task3$total_E[result_task3$total_E < 0] <- 0

# Novelty, extrinsic have total_E but it is not used, 
# so set it to zero 
for(a_name in c("Extrinsic", "Novelty")) {
  m <- result_task3$agent == a_name
  result_task3[["total_E"]][m] <- 0
}

# Cleanup
rm(tmp, agent_name, agent_names, class_names, class_name, 
   exp_name, exp_names, file_names, i, param_codes, 
   run_codes, task_name, m)
```

### Reward (time)
```{r, fig.width=3.2, fig.height=0.7}
p <- 2
r <- 10

result_task3 %>% 
  filter(global_step > 10) %>% 
  filter(param <= p, run <= r) %>% 
  ggplot(aes(x=global_step, y=total_R/global_step, 
             group=interaction(param,run))) +
  geom_line(size=0.1, alpha=1, shape=".") +
  labs(x="Time", y="Reward") +
  scale_x_continuous(limits=c(0, num_episodes),
                     breaks = c(0, num_episodes)) +
  # scale_y_continuous(limits=c(0, 0.022),
                     # breaks = c(0, 0.01, 0.02)) +
  facet_wrap(agent~., nrow=1) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.background = element_blank()) 
```
### Info value (time)
```{r, fig.width=3.2, fig.height=0.7}
p <- 2
r <- 10

result_task3 %>% 
  filter(global_step > 10) %>% 
  filter(param <= p, run <= r) %>% 
  ggplot(aes(x=global_step, y=total_E/global_step, 
             group=interaction(param,run))) +
  geom_line(size=0.1, alpha=1, shape=".") +
  labs(x="Time", y="Info value") +
  scale_x_continuous(limits=c(0, num_episodes),
                     breaks = c(0, num_episodes)) +
  # scale_y_continuous(limits=c(0, 1),
                     # breaks = c(0, 0.5, 1)) +
  facet_wrap(agent~., nrow=1) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.background = element_blank()) 
```

### Value (time)
```{r, fig.width=3.2, fig.height=0.7}
p <- 2
r <- 10

result_task3 %>% 
  filter(global_step > 10) %>% 
  filter(param <= p, run <= r) %>% 
  group_by(agent, param, run) %>% 
  mutate(total_value = total_R + total_E) %>% 
  ggplot(aes(x=global_step, y=total_value/global_step, 
             group=interaction(param,run))) +
  geom_line(size=0.1, alpha=1, shape=".") +
  labs(x="Time", y="Value") +
  scale_x_continuous(limits=c(0, num_episodes),
                     breaks = c(0, num_episodes)) +
  scale_y_continuous(limits=c(0, 1),
                     breaks = c(0, 0.5, 1)) +
  facet_wrap(agent~., nrow=1) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.background = element_blank()) 
```

### Regret (time)
```{r, fig.width=3.2, fig.height=0.7}
p <- 2
r <- 10

result_task3 %>% 
  filter(global_step > 10) %>% 
  filter(param <= p, run <= r) %>% 
  ggplot(aes(x=global_step, y=total_regret/global_step, 
             group=interaction(param,run))) +
  geom_line(size=0.1, alpha=1, shape=".") +
  labs(x="Time", y="Regret") +
  scale_x_continuous(limits=c(0, num_episodes),
                     breaks = c(0, num_episodes)) +
  # scale_y_continuous(limits=c(0, 0.022),
                     # breaks = c(0, 0.01, 0.02)) +
  facet_wrap(agent~., nrow=1) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.background = element_blank()) 
```


### Actions
```{r, fig.width=3, fig.height=2.4}
p <- 10
r <- 7
num_arm <- max(result_task3$action) + 1

result_task3 %>% 
  mutate(
    color = ifelse(strategy == "Curiosity", "mediumpurple4", "black")) %>%
  filter(param <= p, run == r) %>% 
  ggplot(aes(x=global_step, y=action+1, color=color)) +
  geom_point(size=0.2, alpha=0.9) +
  geom_line(size=0.1) +
  scale_x_continuous(
    limits=c(0, num_episodes+(num_episodes*.1)), 
    breaks = c(0, num_episodes)) +
  scale_color_identity() +
  scale_y_continuous(limits=c(0, num_arm+1), breaks = 1:num_arm) +
  labs(x="Time", y="Action") +
  facet_grid(agent~param) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(.1, "lines")) +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") +
  theme(legend.box.background = element_rect(colour = "black", size=1)) +
  theme(plot.title = element_text(size = 6)) +
  theme(strip.text.y = element_text(angle = 0)) +
  theme(strip.text.x = element_blank()) +
  theme(axis.text.y = element_blank()) 
```

### Summary stats
```{r, fig.width=2.1, fig.height=0.9}
result_task3 %>% 
  filter(agent != "Random") %>% 
  group_by(strategy, agent, param, run) %>% 
  summarise(total_R = last(total_R),
            total_E = sum(total_E),
            total_value = last(total_R) + last(total_E),
            total_regret = last(total_regret),
            p_bests = last(p_bests)) %>%
  
  ungroup() %>% 
  group_by(strategy, agent) %>% 
  summarise(median_R = median(total_R), 
            var_R = mad(total_R),
            median_E = median(total_E), 
            var_E = mad(total_E),
            median_total_value = median(total_value), 
            var_total_value = mad(total_value),
            median_regret = median(total_regret),
            var_regret = mad(total_regret),
            median_p_bests=median(p_bests),
            var_p_bests=mad(p_bests)) %>% 
  ungroup() -> tmp

tmp %>% 
  mutate(
    color = ifelse(strategy == "Curiosity", "mediumpurple4", "black")) %>%
  ggplot(aes(x=agent, y=median_R/num_episodes, color=color)) +
  geom_point(size=1, alpha=1) +
  geom_linerange(aes(
    ymin=(median_R+var_R)/num_episodes, 
    ymax=(median_R-var_R)/num_episodes), 
    alpha=0.4) +
  geom_hline(aes(yintercept=max(median_R)/num_episodes), 
             color="black",
             size=0.1) +
  labs(x="", y="Reward") +
  lims(y=c(0.5, 0.9)) +
  scale_color_identity() +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  coord_flip() -> p1

tmp %>% 
  mutate(
    color = ifelse(strategy == "Curiosity", "mediumpurple4", "black")) %>%
  ggplot(aes(x=agent, y=median_total_value/num_episodes, color=color)) +
  geom_point(size=1, alpha=1) +
  geom_linerange(aes(
    ymin=(median_total_value+var_total_value)/num_episodes, 
    ymax=(median_total_value-var_total_value)/num_episodes), 
    alpha=0.4) +
  geom_hline(aes(yintercept=max(median_total_value)/num_episodes), 
             color="black",
             size=0.1) +
  labs(x="", y="Info. value") +
  # lims(y=c(num_episodes/2, num_episodes)) +
  scale_color_identity() +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(axis.text.y = element_blank()) +
  coord_flip() -> p2

tmp %>% 
  mutate(
    color = ifelse(strategy == "Curiosity", "mediumpurple4", "black")) %>%
  ggplot(aes(x=agent, y=median_regret/num_episodes, color=color)) +
  geom_point(size=1, alpha=1) +
  geom_linerange(aes(
    ymin=(median_regret+var_regret)/num_episodes, 
    ymax=(median_regret-var_regret)/num_episodes), 
    alpha=0.4) +
  geom_hline(aes(yintercept=min(median_regret)/num_episodes), 
             color="black",
             size=0.1) +
  labs(x="", y="Regret") +
  scale_color_identity() +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(axis.text.y = element_blank()) +
  coord_flip() -> p3

# -------------------------------------------------------------------
(p1 + p2 + p3) + 
  plot_annotation(title = "Task 3 - Large", 
                  theme = theme_pubr(base_size = 8, legend = "none"))
# print(sub3)
```

## Fig. Task 4
### Load data
```{r, message=FALSE}
# -------------------------------------------------------------
task_name <- "DeceptiveBanditOneHigh10"
task_code <- 4
num_episodes <- 200

# The overestimate due to E0
num_arms <- 10
E_bias <- log(num_arms) * num_arms 

exp_names <- c("exp449", 
               "exp450", 
               "exp451", 
               "exp453", 
               "exp518",
               "exp452", 
               "exp517", 
               "exp520", 
               "exp519", 
               "exp543")

agent_names <- c("Curiosity", 
                 "del-random", 
                 "tau-random", 
                 "Random",
                 "Extrinsic", 
                 "Info", 
                 "Novelty", 
                 "Entropy", 
                 "Count (EB)",
                 "Count (UCB)")

class_names <- c(
  "Curiosity",
  "Random",
  "Random",
  "Random",
  "Extrinsic",
  "Intrinsic",
  "Intrinsic",
  "Intrinsic",
  "Intrinsic",
  "Intrinsic"
)

file_names <- c("action", 
                "p_bests", 
                "total_R",
                "total_E",
                "total_regret")

result_task4 <- NULL
for(i in 1:length(exp_names)){
  exp_name <- exp_names[i]
  agent_name <- agent_names[i]
  class_name <- class_names[i]
  if (agent_name == "Random"){
    param_codes <- c(0)
    run_codes <- 1:100
  } else{
    param_codes <- 0:9
    run_codes <- 1:10
  }
  
  tmp <- load_result(
    exp_name, param_codes, run_codes, file_names, n_max=num_episodes+1)
  
  tmp %>% 
    filter(global_step <= num_episodes) -> tmp
  
  tmp$exp <- exp_name
  tmp$agent <- agent_name
  tmp$task <- task_name
  tmp$task_code <- task_code
  tmp$strategy <- class_name
  tmp$num_episodes <- num_episodes
  
  result_task4 <- bind_rows(result_task4, tmp)
}

# Remove E_bias
result_task4$total_E <- result_task4$total_E - E_bias
result_task4$total_E[result_task4$total_E < 0] <- 0

# Novelty, extrinsic have total_E but it is not used, 
# so set it to zero 
for(a_name in c("Extrinsic", "Novelty")) {
  m <- result_task4$agent == a_name
  result_task4[["total_E"]][m] <- 0
}

# Cleanup
rm(tmp, agent_name, agent_names, class_names, class_name, 
   exp_name, exp_names, file_names, i, param_codes, 
   run_codes, task_name, m)
```

### Actions
```{r, fig.width=3, fig.height=1.4}
p <- 10
r <- 3
num_arm <- max(result_task4$action) + 1

result_task4 %>% 
  mutate(
    color = ifelse(strategy == "Curiosity", "mediumpurple4", "black")) %>%
  filter(param <= p, run == r) %>% 
  ggplot(aes(x=global_step, y=action+1, color=color)) +
  geom_point(size=0.2, alpha=0.9) +
  geom_line(size=0.1) +
  scale_x_continuous(
    limits=c(0, num_episodes+(num_episodes*.1)), 
    breaks = c(0, num_episodes)) +
  scale_color_identity() +
  scale_y_continuous(limits=c(0, num_arm+1), breaks = 1:num_arm) +
  labs(x="Time", y="Action") +
  facet_grid(agent~param) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(.1, "lines")) +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") +
  theme(legend.box.background = element_rect(colour = "black", size=1)) +
  theme(plot.title = element_text(size = 6)) +
  theme(strip.text.y = element_text(angle = 0)) +
  theme(strip.text.x = element_blank()) +
  theme(axis.text.y = element_blank()) 
```

### Reward (time)
```{r, fig.width=3.2, fig.height=0.7}
p <- 2
r <- 10

result_task4 %>% 
  filter(global_step > 10) %>% 
  filter(param <= p, run <= r) %>% 
  ggplot(aes(x=global_step, y=total_R/global_step, 
             group=interaction(param,run))) +
  geom_line(size=0.1, alpha=1, shape=".") +
  labs(x="Time", y="Reward") +
  scale_x_continuous(limits=c(0, num_episodes),
                     breaks = c(0, num_episodes)) +
  # scale_y_continuous(limits=c(0, 0.022),
                     # breaks = c(0, 0.01, 0.02)) +
  facet_wrap(agent~., nrow=1) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.background = element_blank()) 
```
### Info value (time)
```{r, fig.width=3.2, fig.height=0.7}
p <- 2
r <- 10

result_task4 %>% 
  filter(global_step > 10) %>% 
  filter(param <= p, run <= r) %>% 
  ggplot(aes(x=global_step, y=total_E/global_step, 
             group=interaction(param,run))) +
  geom_line(size=0.1, alpha=1, shape=".") +
  labs(x="Time", y="Info value") +
  scale_x_continuous(limits=c(0, num_episodes),
                     breaks = c(0, num_episodes)) +
  # scale_y_continuous(limits=c(0, 1),
                     # breaks = c(0, 0.5, 1)) +
  facet_wrap(agent~., nrow=1) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.background = element_blank()) 
```

### Value (time)
```{r, fig.width=3.2, fig.height=0.7}
p <- 2
r <- 10

result_task4 %>% 
  filter(global_step > 10) %>% 
  filter(param <= p, run <= r) %>% 
  group_by(agent, param, run) %>% 
  mutate(total_value = total_R + total_E) %>% 
  ggplot(aes(x=global_step, y=total_value/global_step, 
             group=interaction(param,run))) +
  geom_line(size=0.1, alpha=1, shape=".") +
  labs(x="Time", y="Value") +
  scale_x_continuous(limits=c(0, num_episodes),
                     breaks = c(0, num_episodes)) +
  scale_y_continuous(limits=c(0, 1),
                     breaks = c(0, 0.5, 1)) +
  facet_wrap(agent~., nrow=1) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.background = element_blank()) 
```

### Summary stats
```{r, fig.width=2.1, fig.height=0.9}
result_task4 %>% 
  filter(agent != "Random") %>% 
  group_by(strategy, agent, param, run) %>% 
  summarise(total_R = last(total_R),
            total_E = sum(total_E),
            total_value = last(total_R) + last(total_E),
            total_regret = last(total_regret),
            p_bests = last(p_bests)) %>%
  
  ungroup() %>% 
  group_by(strategy, agent) %>% 
  summarise(median_R = median(total_R), 
            var_R = mad(total_R),
            median_E = median(total_E), 
            var_E = mad(total_E),
            median_total_value = median(total_value), 
            var_total_value = mad(total_value),
            median_regret = median(total_regret),
            var_regret = mad(total_regret),
            median_p_bests=median(p_bests),
            var_p_bests=mad(p_bests)) %>% 
  ungroup() -> tmp

tmp %>% 
  mutate(
    color = ifelse(strategy == "Curiosity", "mediumpurple4", "black")) %>%
  ggplot(aes(x=agent, y=median_R/num_episodes, color=color)) +
  geom_point(size=1, alpha=1) +
  geom_linerange(aes(
    ymin=(median_R+var_R)/num_episodes, 
    ymax=(median_R-var_R)/num_episodes), 
    alpha=0.4) +
  geom_hline(aes(yintercept=max(median_R)/num_episodes), 
             color="black",
             size=0.1) +
  labs(x="", y="Reward") +
  scale_y_continuous(limits=c(0, 0.5), breaks=c(0.0, 0.25, 0.5)) +
  scale_color_identity() +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  coord_flip() -> p1

tmp %>% 
  mutate(
    color = ifelse(strategy == "Curiosity", "mediumpurple4", "black")) %>%
  ggplot(aes(x=agent, y=median_E/num_episodes, color=color)) +
  geom_point(size=1, alpha=1) +
  geom_linerange(aes(
    ymin=(median_E+var_E)/num_episodes, 
    ymax=(median_E-var_E)/num_episodes), 
    alpha=0.4) +
  geom_hline(aes(yintercept=max(median_E)/num_episodes), 
             color="black",
             size=0.1) +
  labs(x="", y="Info, value") +
  # lims(y=c(num_episodes/2, num_episodes)) +
  scale_color_identity() +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(axis.text.y = element_blank()) +
  coord_flip() -> p2

tmp %>% 
  mutate(
    color = ifelse(strategy == "Curiosity", "mediumpurple4", "black")) %>%
  ggplot(aes(x=agent, y=median_regret/num_episodes, color=color)) +
  geom_point(size=1, alpha=1) +
  geom_linerange(aes(
    ymin=(median_regret+var_regret)/num_episodes, 
    ymax=(median_regret-var_regret)/num_episodes), 
    alpha=0.4) +
  geom_hline(aes(yintercept=max(median_regret)/num_episodes), 
             color="black",
             size=0.1) +
  labs(x="", y="Regret") +
  scale_color_identity() +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(axis.text.y = element_blank()) +
  coord_flip() -> p3

# -------------------------------------------------------------------
(p1 + p2 + p3) + 
  plot_annotation(title = "Task 4 - Deception", 
                  theme = theme_pubr(base_size = 8, legend = "none"))
# print(sub4)
```

## Fig. Task 5
### Load data
```{r, message=FALSE}
# -------------------------------------------------------------
task_name <- "DistractionBanditOneHigh10"
task_code <- 5
num_episodes <- 10 * 50

# The overestimate due to E0
num_arms <- 10
E_bias <- log(num_arms) * num_arms 

exp_names <- c("exp462", 
               "exp463", 
               "exp464", 
               "exp466", 
               "exp522",
               "exp465", 
               "exp521", 
               "exp524", 
               "exp523", 
               "exp544")

agent_names <- c("Curiosity", 
                 "del-random", 
                 "tau-random", 
                 "Random",
                 "Extrinsic", 
                 "Info", 
                 "Novelty", 
                 "Entropy", 
                 "Count (EB)",
                 "Count (UCB)")

class_names <- c(
  "Curiosity",
  "Random",
  "Random",
  "Random",
  "Extrinsic",
  "Intrinsic",
  "Intrinsic",
  "Intrinsic",
  "Intrinsic",
  "Intrinsic"
)

file_names <- c("action", 
                "p_bests", 
                "total_R",
                "total_E",
                "total_regret")

result_task5 <- NULL
for(i in 1:length(exp_names)){
  exp_name <- exp_names[i]
  agent_name <- agent_names[i]
  class_name <- class_names[i]
  if (agent_name == "Random"){
    param_codes <- c(0)
    run_codes <- 1:100
  } else{
    param_codes <- 0:9
    run_codes <- 1:10
  }
  
  tmp <- load_result(
    exp_name, param_codes, run_codes, file_names, n_max=num_episodes+1)
  
  tmp %>% 
    filter(global_step <= num_episodes) -> tmp
  tmp$exp <- exp_name
  tmp$agent <- agent_name
  tmp$task <- task_name
  tmp$task_code <- task_code
  tmp$strategy <- class_name
  tmp$num_episodes <- num_episodes
  
  result_task5 <- bind_rows(result_task5, tmp)
}

# Remove E_bias
result_task5$total_E <- result_task5$total_E - E_bias
result_task5$total_E[result_task5$total_E < 0] <- 0

# Novelty, extrinsic have total_E but it is not used, 
# so set it to zero 
for(a_name in c("Extrinsic", "Novelty")) {
  m <- result_task5$agent == a_name
  result_task5[["total_E"]][m] <- 0
}

# Cleanup
rm(tmp, agent_name, agent_names, class_names, class_name, 
   exp_name, exp_names, file_names, i, param_codes, 
   run_codes, task_name, m)
```

### Actions
```{r, fig.width=3, fig.height=1.4}
p <- 10
r <- 3
num_arm <- max(result_task5$action) + 1

result_task5 %>% 
  mutate(
    color = ifelse(strategy == "Curiosity", "mediumpurple4", "black")) %>%
  filter(param <= p, run == r) %>% 
  ggplot(aes(x=global_step, y=action+1, color=color)) +
  geom_point(size=0.2, alpha=0.9) +
  geom_line(size=0.1) +
  scale_x_continuous(
    limits=c(0, num_episodes+(num_episodes*.1)), 
    breaks = c(0, num_episodes)) +
  scale_color_identity() +
  scale_y_continuous(limits=c(0, num_arm+1), breaks = 1:num_arm) +
  labs(x="Time", y="Action") +
  facet_grid(agent~param) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(.1, "lines")) +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") +
  theme(legend.box.background = element_rect(colour = "black", size=1)) +
  theme(plot.title = element_text(size = 6)) +
  theme(strip.text.y = element_text(angle = 0)) +
  theme(strip.text.x = element_blank()) +
  theme(axis.text.y = element_blank()) 
```

### Reward (time)
```{r, fig.width=3.2, fig.height=0.7}
p <- 2
r <- 10

result_task5 %>% 
  filter(global_step > 20) %>% 
  filter(param <= p, run <= r) %>% 
  ggplot(aes(x=global_step, y=total_R/global_step, 
             group=interaction(param,run))) +
  geom_line(size=0.1, alpha=1, shape=".") +
  labs(x="Time", y="Reward") +
  scale_x_continuous(limits=c(0, num_episodes),
                     breaks = c(0, num_episodes)) +
  # scale_y_continuous(limits=c(0, 0.022),
                     # breaks = c(0, 0.01, 0.02)) +
  facet_wrap(agent~., nrow=1) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.background = element_blank()) 
```
### Info value (time)
```{r, fig.width=3.2, fig.height=0.7}
p <- 2
r <- 10

result_task5 %>% 
  filter(global_step > 10) %>% 
  filter(param <= p, run <= r) %>% 
  ggplot(aes(x=global_step, y=total_E/global_step, 
             group=interaction(param,run))) +
  geom_line(size=0.1, alpha=1, shape=".") +
  labs(x="Time", y="Info value") +
  scale_x_continuous(limits=c(0, num_episodes),
                     breaks = c(0, num_episodes)) +
  # scale_y_continuous(limits=c(0, 1),
                     # breaks = c(0, 0.5, 1)) +
  facet_wrap(agent~., nrow=1) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.background = element_blank()) 
```

### Value (time)
```{r, fig.width=3.2, fig.height=0.7}
p <- 2
r <- 10

result_task5 %>% 
  filter(global_step > 20) %>% 
  filter(param <= p, run <= r) %>% 
  group_by(agent, param, run) %>% 
  mutate(total_value = total_R + total_E) %>% 
  ggplot(aes(x=global_step, y=total_value/global_step, 
             group=interaction(param,run))) +
  geom_line(size=0.1, alpha=1, shape=".") +
  labs(x="Time", y="Value") +
  scale_x_continuous(limits=c(0, num_episodes),
                     breaks = c(0, num_episodes)) +
  # scale_y_continuous(limits=c(0, 0.022),
                     # breaks = c(0, 0.01, 0.02)) +
  facet_wrap(agent~., nrow=1) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.background = element_blank()) 
```

### Regret (time)
```{r, fig.width=3.2, fig.height=0.7}
p <- 2
r <- 10

result_task5 %>% 
  filter(global_step > 20) %>% 
  filter(param <= p, run <= r) %>% 
  ggplot(aes(x=global_step, y=total_regret/global_step, 
             group=interaction(param,run))) +
  geom_line(size=0.1, alpha=1, shape=".") +
  labs(x="Time", y="Regret") +
  scale_x_continuous(limits=c(0, num_episodes),
                     breaks = c(0, num_episodes)) +
  # # scale_y_continuous(limits=c(0, 0.022),
  #                    breaks = c(0, 0.01, 0.02)) +
  facet_wrap(agent~., nrow=1) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.background = element_blank()) 
```


### Summary stats
```{r, fig.width=2.1, fig.height=0.9}
result_task5 %>% 
  filter(agent != "Random") %>% 
  group_by(strategy, agent, param, run) %>% 
  summarise(total_R = last(total_R),
            total_E = sum(total_E),
            total_value = last(total_R) + last(total_E),
            total_regret = last(total_regret),
            p_bests = last(p_bests)) %>%
  
  ungroup() %>% 
  group_by(strategy, agent) %>% 
  summarise(median_R = median(total_R), 
            var_R = mad(total_R),
            median_E = median(total_E), 
            var_E = mad(total_E),
            median_total_value = median(total_value), 
            var_total_value = mad(total_value),
            median_regret = median(total_regret),
            var_regret = mad(total_regret),
            median_p_bests=median(p_bests),
            var_p_bests=mad(p_bests)) %>% 
  ungroup() -> tmp

tmp %>% 
  mutate(
    color = ifelse(strategy == "Curiosity", "mediumpurple4", "black")) %>%
  ggplot(aes(x=agent, y=median_R/num_episodes, color=color)) +
  geom_point(size=1, alpha=1) +
  geom_linerange(aes(
    ymin=(median_R+var_R)/num_episodes, 
    ymax=(median_R-var_R)/num_episodes), 
    alpha=0.4) +
  geom_hline(aes(yintercept=max(median_R)/num_episodes), 
             color="black",
             size=0.1) +
  labs(x="", y="Reward") +
  lims(y=c(0.5, 0.9)) +
  scale_color_identity() +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  coord_flip() -> p1

tmp %>% 
  mutate(
    color = ifelse(strategy == "Curiosity", "mediumpurple4", "black")) %>%
  ggplot(aes(x=agent, y=median_E/num_episodes, color=color)) +
  geom_point(size=1, alpha=1) +
  geom_linerange(aes(
    ymin=(median_E+var_E)/num_episodes, 
    ymax=(median_E-var_E)/num_episodes), 
    alpha=0.4) +
  geom_hline(aes(yintercept=max(median_E)/num_episodes), 
             color="black",
             size=0.1) +
  labs(x="", y="Info. value") +
  # lims(y=c(num_episodes/2, num_episodes)) +
  scale_color_identity() +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(axis.text.y = element_blank()) +
  coord_flip() -> p2

tmp %>% 
  mutate(
    color = ifelse(strategy == "Curiosity", "mediumpurple4", "black")) %>%
  ggplot(aes(x=agent, y=median_regret/num_episodes, color=color)) +
  geom_point(size=1, alpha=1) +
  geom_linerange(aes(
    ymin=(median_regret+var_regret)/num_episodes, 
    ymax=(median_regret-var_regret)/num_episodes), 
    alpha=0.4) +
  geom_hline(aes(yintercept=min(median_regret)/num_episodes), 
             color="black",
             size=0.1) +
  labs(x="", y="Regret") +
  scale_color_identity() +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(axis.text.y = element_blank()) +
  coord_flip() -> p3

# -------------------------------------------------------------------
(p1 + p2 + p3) + 
  plot_annotation(title = "Task 5 - Deception", 
                  theme = theme_pubr(base_size = 8, legend = "none"))
# print(sub5)
```


## Fig. Task1-5
```{r, fig.width=2.1, fig.height=4.5}
# sub1 / sub2 / sub3 / sub4 / sub5
```

# Old plots for easy task 1 
## Sub 1 - examples
```{r, fig.height=1.5, fig.width=1}
result393_7 %>% 
filter(agent == "Deterministic") %>% 
  # filter(global_step < 40) %>%
  filter(run == 1, param <= 10) %>% 
  ggplot(aes(x=global_step, y=action)) +
  geom_line(size=0.5, alpha=1, color="mediumpurple4") +
  scale_x_continuous(breaks=c(0, 100, 200)) +
  labs(x="Time", y="Choice", title="Deterministic") +
  facet_wrap(.~param, ncol=1) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(0.1, "lines")) +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") +
  theme(legend.box.background = element_rect(colour = "black", size=1)) +
  theme(plot.title = element_text(size = 6)) +
  theme(strip.text.y = element_text(angle = 0)) +
  theme(strip.text.x = element_blank()) +
  theme(axis.text.y = element_blank()) +
  theme(axis.ticks = element_blank()) + 
  theme(legend.key.size = unit(0.2, "cm")) -> p1

result393_7 %>% 
filter(agent == "Stochastic") %>% 
  # filter(global_step < 40) %>%
  filter(run == 1, param <= 10) %>% 
  ggplot(aes(x=global_step, y=action)) +
  geom_line(size=0.5, alpha=1, color="mediumpurple3") +
  labs(x="Time", y="", title="Stochastic") +
  scale_x_continuous(breaks=c(0, 100, 200)) +
  facet_wrap(.~param, ncol=1) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(0.1, "lines")) +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") +
  theme(legend.box.background = element_rect(colour = "black", size=1)) +
  theme(plot.title = element_text(size = 6)) +
  theme(strip.text.y = element_text(angle = 0)) +
  theme(strip.text.x = element_blank()) +
  # theme(axis.text.x = element_blank()) +
  theme(axis.text.y = element_blank()) +
  theme(axis.ticks = element_blank()) + 
  theme(legend.key.size = unit(0.2, "cm")) -> p2

c1 <- p1 + p2
```

## Sub 2 - dists
```{r, fig.height=1.5, fig.width=0.8}
num_episodes <- 200

# average value
summary393_7 %>% 
  ggplot(aes(x=agent, y=total_R/num_episodes, color=agent)) +
  geom_jitter(size=0.3, alpha=0.9, width=0.2) +
  stat_summary(fun=median, color="black", alpha=0.9, size=2, shape="-") +
  scale_colour_manual("", 
                      values=c("mediumpurple4", "mediumpurple3", "darkgray")) +
  lims(y=c(0,1)) +
  labs(x="", y="Total reward") +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") + 
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(1, "lines")) +
  theme(axis.text.x = element_blank()) -> 
  p1

# Total regret
summary393_7 %>% 

  ggplot(aes(x=agent, y=total_regret/num_episodes, color=agent)) +
  geom_jitter(size=0.3, alpha=0.9, width=0.2) +
  stat_summary(fun=median, color="black", alpha=0.9, size=2, shape="-") +
  scale_colour_manual("", 
                      values=c("mediumpurple4", "mediumpurple3", "darkgray")) +
  labs(x="", y="Total regret") +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") + 
  theme(strip.background = element_blank()) +
  theme(axis.text.x = element_text(angle = 90)) +
  theme(panel.spacing = unit(1, "lines")) ->
  p2

c2 <- p1 / p2
```

## Build figure
```{r, fig.height=1.7, fig.width=1.5}
fig <- (c1 | c2 + plot_spacer()) + 
  plot_layout(widths = c(0.75, 0.25)) +
    plot_annotation(
      title="Cusiosity and reward collection in a random world", 
      theme = theme_pubr(base_size = 8, legend = "none"))

print(fig)

# -- Save a to pdf ---
name <- "img/reward_collection"
ggsave(paste(name, ".pdf", sep=""), plot=fig, height = 2.2*2, width = 1.5*2)

# -
# rm(c1, c2)
```


# Figure 4 - Reward collection in difficult envinronments
- Harder problems, using a broader range of exploration strategies
- Only show final results
- Need cartoons

## Load data
### Load
```{r, message=FALSE}
# --- Init files ---

# The exps are:
exp_names <- c("exp393", 
               "exp394", 
               "exp395", 
               "exp396", 
               "exp397")
agent_names <- c("Curiosity", 
                 "del-Random", 
                 "tau-Random", 
                 "Intrinsic", 
                 "Random")

# These are shared in all models, but Random.
param_codes <- 0:9
run_codes <- 1:10

# Load only data every model has:
file_names <- c("action", 
                "p_bests", 
                "regret", 
                "total_R",
                "total_regret")

# -- Load ---
bandit_results <- NULL

# 1. Load random first (diff file structure)
bandit_results <- load.result(exp_names[5], c(0), 1:100, file_names)
bandit_results$exp <- exp_names[5]
bandit_results$agent <- agent_names[5]

# 2. then load the rest
for(i in 1:length(exp_names[1:4])){
  result <- load.result(exp_names[i], param_codes, run_codes, file_names)
  result$exp <- exp_names[i]
  result$agent <- agent_names[i]
  bandit_results <- bind_rows(bandit_results, result)
  rm(result)
}

# 3. summarize 
bandit_results %>% 
  group_by(agent, param, run) %>% 
  summarise(
    total_R=last(total_R),
    total_regret=last(total_regret),
    p_bests=last(p_bests)
  ) %>% 
  ungroup() ->
bandit_summary

# Reorder names
ordered_names <- c("Curiosity",
                   "Intrinsic", 
                   "tau-Random", 
                   "del-Random", 
                   "Random")
ordered_colors <- c("mediumpurple4", 
                    "mediumpurple3", 
                    "goldenrod4", 
                    "darkgoldenrod3", 
                    "darkgrey")
bandit_results$agent <- factor(bandit_results$agent, levels = ordered_names)
bandit_summary$agent <- factor(bandit_summary$agent, levels = ordered_names)

# 5. Cleanup
rm(file_names, agent_names, exp_names, param_codes, run_codes, i)
```

### Sub 1 - actions examples
```{r, fig.width=1.8, fig.height=1.6}
bandit_results %>% 
  filter(agent != "Random") %>% 
  filter(run <= 10, param == 0) %>% 
  ggplot(aes(x=global_step, y=action, color=agent)) +
  geom_line(size=0.6, alpha=1) +
  labs(x="Time", y="Choice") +
  facet_grid(run~agent) +
  scale_colour_manual("", values=ordered_colors) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(panel.spacing = unit(0.24, "lines")) +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") +
  theme(legend.box.background = element_rect(colour = "black", size=1)) +
  theme(plot.title = element_text(size = 6)) +
  theme(strip.text.y = element_blank()) +
  theme(axis.text.x = element_blank()) +
  theme(axis.text.y = element_blank()) +
  theme(axis.ticks = element_blank()) + 
  theme(legend.key.size = unit(0.2, "cm")) -> sub1
```

### Sub 2 - value summary
```{r, fig.width=1.2, fig.height=1.6}
num_episodes <- 200

## Values
bandit_summary %>% 
  ggplot(aes(x=agent, y=total_R/num_episodes, color=agent)) +
  geom_jitter(size=0.01, alpha=0.5, width=0.3) +
  stat_summary(fun=median, alpha=1, color="black", size=2, shape="-") +
  scale_colour_manual("", values=ordered_colors) +
  labs(y="Total reward", x="") +
  lims(y=c(0, 1)) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") + 
  theme(strip.background = element_blank()) +
  theme(axis.text.x = element_blank()) +
  theme(panel.spacing = unit(1, "lines")) -> p1

bandit_summary %>% 
  ggplot(aes(x=agent, y=total_regret/num_episodes, color=agent)) +
  geom_jitter(size=0.01, alpha=0.5, width=0.3) +
  stat_summary(fun=median, alpha=1, color="black", size=2, shape="-") +
  scale_colour_manual("", values=ordered_colors) +
  labs(y="Total regret", x="") +
  lims(y=c(0, 1)) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") + 
  theme(strip.background = element_blank()) +
  theme(axis.text.x = element_text(angle = 90)) +
  theme(panel.spacing = unit(1, "lines")) -> p2

bandit_summary %>% 
  ggplot(aes(x=agent, y=p_bests, color=agent)) +
  geom_jitter(size=0.05, alpha=0.5, width=0.3) +
  stat_summary(fun=median, alpha=1, color="black", size=2, shape="-") +
  scale_colour_manual("", values=ordered_colors) +
  labs(y="Best choice", x="") +
  lims(y=c(0, 1)) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") + 
  theme(strip.background = element_blank()) +
  theme(axis.text.x = element_text(angle = 90)) +
  theme(panel.spacing = unit(1, "lines")) -> p3

sub2 <- p1 / p2 
```

### Build
```{r, fig.width=2.6, fig.height=2.4}
sub1 + (sub2 + plot_spacer()) + 
  plot_layout(widths = c(0.8, 0.2)) + 
  plot_annotation(
      title="Task 1 - reward collection with a high payout", 
                  theme = theme_pubr(base_size = 8, legend = "none"))
```


# Figure 5 - Hard envionments, under unexpected time pressure.
- Reuse HPs from Figure 4.
- Is curiosity a problem here?
- TODO
## Load data
```{r}

```
## Build figure

# -------------------------------------------------------------------
# Supp 1 - Indep explore/exploit: det versus sto
## Load data
```{r, message=FALSE}
# -------------------------------------------------------------
load.result <- function(exp_name, param_codes, run_codes, file_names){
  num_files <- length(file_names)
  result <- NULL
  for (param in param_codes){
    for (run in run_codes) {
      runtmp <- read_csv(paste(data_path, 
                               exp_name, 
                               paste("param", param, sep=""), 
                               paste("run", run, sep=""), 
                               paste(file_names[1], "csv", sep="."), sep="/"))    
      for (name in file_names[2:num_files]){
        tmp <- read_csv(paste(data_path, 
                              exp_name, 
                              paste("param", param, sep=""), 
                              paste("run", run, sep=""), 
                              paste(name, "csv", sep="."), sep="/"))  
        runtmp[[name]] <- tmp[[name]]
      }
      runtmp$run <- run
      runtmp$param <- param
      result <- bind_rows(result, runtmp)  
    }
  }
  result
}

# --------------------------------------------------------------------
exp_name <- "exp456"
param_codes <- 0:9
run_codes <- 1:10
file_names <- c("score_E", 
                "score_R", 
                "action", 
                "p_bests", 
                "regret", 
                "value_E", 
                "value_R", 
                "policy",
                "total_E", 
                "total_R",
                "total_regret")

result456 <- load.result(exp_name, param_codes, run_codes, file_names)
result456 %>% 
  group_by(param, run) %>% 
  summarise(
    total_E=last(total_E),
    total_R=last(total_R),
    total_regret=last(total_regret),
    value_E=last(value_E),
    value_R=last(value_R),
    p_bests=last(p_bests)
  ) %>% 
  ungroup() ->
summary456

# --------------------------------------------------------------------
exp_name <- "exp457"
param_codes <- 0:9
run_codes <- 1:10
file_names <- c("score_E", 
                "score_R", 
                "action", 
                "p_bests", 
                "regret", 
                "value_E", 
                "value_R", 
                "policy",
                "total_E", 
                "total_R",
                "total_regret")

result457 <- load.result(exp_name, param_codes, run_codes, file_names)
result457 %>% 
  group_by(param, run) %>% 
  summarise(
    total_E=last(total_E),
    total_R=last(total_R),
    total_regret=last(total_regret),
    value_E=last(value_E),
    value_R=last(value_R),
    p_bests=last(p_bests)
  ) %>% 
  ungroup() ->
summary457

# --------------------------------------------------------------------
exp_name <- "exp402"
param_codes <- c(0)
run_codes <- 1:100
file_names <- c("score_R", 
                "action", 
                "p_bests", 
                "regret", 
                "total_R",
                "value_R",
                "total_regret")

result402 <- load.result(exp_name, param_codes, run_codes, file_names)
result402 <- filter(result402, global_step <= 80) 
result402 %>% 
  group_by(param, run) %>% 
  summarise(
    total_R=last(total_R),
    value_R=last(value_R),
    total_regret=last(total_regret),
    p_bests=last(p_bests)
  ) %>% 
  ungroup() ->
summary402

# ---------------------------------------------------------------------
result456 %>% 
  dplyr::select(
    global_step, param, run, action, total_R, score_R, value_R,
    total_regret, p_bests) -> tmp1
result457 %>% 
  dplyr::select(
    global_step, param, run, action, total_R, score_R, value_R,
    total_regret, p_bests) -> tmp2
result402 %>% 
  dplyr::select(
    global_step, param, run, action, total_R, score_R, value_R,
    total_regret, p_bests) -> tmp3

tmp1$agent <- "Stochastic"
tmp2$agent <- "Deterministic"
tmp3$agent <- "Random"

result456_457 <- tmp1
result456_457 <- bind_rows(result456_457, tmp2)
result456_457 <- bind_rows(result456_457, tmp3)


# -----------------------------------------------------------------------
summary456 %>% 
  dplyr::select(param, run, total_R, value_R, total_regret, p_bests) -> tmp1
summary457 %>% 
  dplyr::select(param, run, total_R, value_R, total_regret, p_bests) -> tmp2
summary402 %>% 
  dplyr::select(param, run, total_R, value_R, total_regret, p_bests) -> tmp3

tmp1$agent <- "Stochastic"
tmp2$agent <- "Deterministic"
tmp3$agent <- "Random"

summary456_457 <- tmp1
summary456_457 <- bind_rows(summary456_457, tmp2)
summary456_457 <- bind_rows(summary456_457, tmp3)

summary456_457$agent <- factor(summary456_457$agent,
                               levels=c(
                                 "Deterministic", "Stochastic", "Random"))
```

## Sub 1a - action example
```{r, fig.width=1.6, fig.height=2}
result456_457 %>% 
  filter(agent == "Deterministic") %>% 
  # filter(global_step < 40) %>%
  filter(run <= 10, param == 1) %>%
  ggplot(aes(x=global_step, y=action, color=actor)) +
  geom_line(size=0.6, alpha=1) +
  labs(x="", y="Choice", title="Deterministic") +
  facet_grid(run~param) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  scale_x_continuous(limits=c(-6, 86), breaks=c(0, 40, 80)) +
  scale_color_manual("Search", values=c("mediumpurple4")) +
  theme(panel.spacing = unit(0.1, "lines")) +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") +
  theme(legend.box.background = element_rect(colour = "black", size=1)) +
  theme(plot.title = element_text(size = 6)) +
  theme(strip.text = element_blank()) +
  # theme(axis.text.x = element_blank()) +
  theme(axis.text.y = element_blank()) +
  theme(axis.ticks.y = element_blank()) + 
  theme(legend.key.size = unit(0.2, "cm")) -> 
  p1

result456_457 %>% 
  filter(agent == "Stochastic") %>% 
  filter(run <= 10, param == 1) %>%
  ggplot(aes(x=global_step, y=action, color=actor)) +
  geom_line(size=0.6, alpha=1) +
  labs(x="Time", y="", title="Stochastic") +
  facet_grid(run~param) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  scale_color_manual("Search", values=c("mediumpurple3")) +
  scale_x_continuous(limits=c(-6, 86), breaks=c(0, 40, 80)) +
  theme(panel.spacing = unit(0.1, "lines")) +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") +
  theme(plot.title = element_text(size = 6)) +
  theme(legend.box.background = element_rect(colour = "black", size=1)) +
  theme(strip.text = element_blank()) +
  theme(axis.title.x = element_text(hjust = -.25)) +
  theme(axis.text.y = element_blank()) +
  theme(axis.ticks.y = element_blank()) + 
  theme(legend.key.size = unit(0.2, "cm")) -> 
  p2
```

## Sub 1b - reward value (timecourse)
```{r, fig.width=1.6, fig.height=0.6}
result456_457 %>% 
  filter(run <= 10, param == 1) %>%
  filter(agent != "Random") %>%
  ggplot(aes(x=global_step, y=value_R,
             color=agent, group=agent)) +
  geom_point(size=0.8, alpha=0.9, shape=".") +
  # approx median smooth
  geom_quantile(size=1, quantiles = 0.5, method = "rqss", color="black") + 
  labs(x="Time", y="Reward value") +
  facet_wrap(agent~., ncol=2) +
  scale_x_continuous(limits=c(-6, 86), breaks=c(0, 40, 80)) +
  scale_y_continuous(breaks=c(0, 0.5, 1), limits=c(-.1, 1.1)) +
  
  scale_colour_manual("Policy", values=c("mediumpurple4", "mediumpurple3")) +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(1, "lines")) +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") +
  theme(legend.box.background = element_rect(colour = "black", size=1)) +
  theme(plot.title = element_text(size = 6)) +
  theme(strip.text = element_blank()) +
  # theme(axis.text.x = element_blank()) +
  # theme(axis.text.y = element_blank()) +
  # theme(axis.ticks = element_blank()) + 
  theme(legend.key.size = unit(0.2, "cm")) ->
  p3


sub1 <- (p1 + p2) / p3 + plot_layout(heights = c(0.85, 0.15))
```

## Sub 2 - summary value (jitter)
```{r, fig.height=0.9, fig.width=0.6}
# average value
summary456_457 %>% 
  ggplot(aes(x=agent, y=total_R/num_episodes, color=agent)) +
  geom_jitter(size=0.3, alpha=0.9, width=0.2) +
  stat_summary(fun=median, color="black", alpha=0.9, size=2, shape="-") +
  scale_colour_manual("", 
                      values=c("mediumpurple4", "mediumpurple3", "darkgray")) +
  scale_y_continuous(breaks=c(0, 0.5, 1), limits=c(-.1, 1.1)) +
  labs(x="", y="Total reward") +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") + 
  theme(strip.background = element_blank()) +
  theme(panel.spacing = unit(1, "lines")) +
  theme(axis.text.x = element_blank()) -> 
  p1

# Total regret
summary456_457 %>% 
  ggplot(aes(x=agent, y=total_regret/num_episodes, color=agent)) +
  geom_jitter(size=0.3, alpha=0.9, width=0.2) +
  stat_summary(fun=median, color="black", alpha=0.9, size=2, shape="-") +
  scale_colour_manual("", 
                      values=c("mediumpurple4", "mediumpurple3", "darkgray")) +
  labs(x="", y="Total regret") +
  scale_y_log10() +
  annotation_logticks(sides = "l") +
  theme_pubr(base_size = 6, legend = "none") +
  theme(strip.background = element_blank()) +
  theme(legend.position = "none") + 
  theme(strip.background = element_blank()) +
  theme(axis.text.x = element_text(angle = 90)) +
  theme(panel.spacing = unit(1, "lines")) ->
  p2

# ---
sub2 <- p1 / p2 
print(sub3)
```

## Build figure
```{r, fig.height=2.2, fig.width=1.7}
fig <- (sub1 | (sub2  + plot_spacer())) + 
  plot_layout(widths = c(0.8, 0.2)) +
    plot_annotation(
      title="Reward collection with independent policies:",
      subtitle = "deterministic versus stochastic",
                  theme = theme_pubr(base_size = 8, legend = "none"))

print(fig)

# -- Save a to pdf --
name <- "img/supp_independent_sto_v_det"
ggsave(paste(name, ".pdf", sep=""), plot=fig, height = 2.6*2, width = 2*2)
```


# Supp 2 - Forcing determinism on Fig 3.
- Can this help
